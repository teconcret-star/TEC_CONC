<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CPTec</title>
  <style>
    :root{
      --bg:#e9f1fb;
      --panel:#f7fbff;
      --border:#7b9cc5;
      --grid:#b9cbe5;
      --text:#0b1d33;
      --muted:#3a4e6b;
      --accent:#0a6ed1;
      --warn:#e0a100;
      --danger:#c73535;
      --success:#1b8e5a;
      --focus:#0a6ed1;
      --shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Tahoma", "Segoe UI", Arial, sans-serif;
      background: linear-gradient(180deg, #ffffff 0%, var(--bg) 100%);
      color: var(--text);
      line-height: 1.35;
    }

    /* header with logo support */
    header{ max-width: 1220px; margin: 0 auto; padding: 18px 14px 8px; position: relative; }
    .header-logo{
      position: absolute;
      top: 12px;
      right: 14px;
      height: 56px;
      width: auto;
      object-fit: contain;
      pointer-events: none;
    }
    @media (max-width: 700px){
      .header-logo{ height:44px; top:10px; right:10px; }
    }
    @media print{
      .header-logo{ display:none !important; }
    }

    header h1{ margin:0 0 4px; font-size:19px; font-weight:700; color: var(--accent); }
    header p{ margin:0; color:var(--muted); font-size:12px; }
    main{ max-width: 1220px; margin: 0 auto; padding: 10px 14px 24px; display: grid; gap: 12px; }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background: linear-gradient(180deg, #f8fbff 0%, #e6f0fa 100%);
      border: 1px solid var(--border);
      border-radius: 6px; padding: 10px 12px; box-shadow: var(--shadow);
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px; border:1px solid var(--border); border-radius: 999px;
      background: #eef5ff; color: var(--muted); font-size: 11px;
    }
    .pill strong{ color: var(--text); font-weight: 700; }

    .tabs{ display:flex; gap:6px; flex-wrap:wrap; }
    .tab-btn{
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #dce9f7 100%);
      color: var(--text);
      padding: 8px 12px; border-radius: 4px;
      font-weight: 700; cursor: pointer; font-size: 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
    }
    .tab-btn[aria-selected="true"]{
      border-color: #1f4e8c;
      background: linear-gradient(180deg, #dbe9f8 0%, #b6cdea 100%);
      color: #0b1d33;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px; padding: 12px; box-shadow: var(--shadow);
    }
    .card h2{ margin:0 0 10px; font-size:14px; font-weight:800; color: #0b1d33; text-transform: uppercase; letter-spacing: 0.2px; }
    .card h3{ margin:0 0 8px; font-size:13px; font-weight:800; color: #0b1d33; }
    .hint{ margin: 8px 0 0; font-size: 11px; color: var(--muted); }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .grid-1{ grid-template-columns: 1fr; }
    .grid-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } .grid-3{ grid-template-columns: 1fr; } }

    label{ display:block; font-size: 11px; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.2px; }
    input, select, textarea{
      width: 100%; padding: 8px 9px; border-radius: 2px;
      border: 1px solid #8aa6c7; background: #fff;
      color: var(--text); outline: none; font-size: 13px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 2px rgba(10,110,209,0.2);
    }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top: 10px; }
    button{
      appearance:none; border: 1px solid #1f4e8c; border-radius: 3px;
      padding: 9px 11px; font-weight: 800; cursor: pointer;
      background: linear-gradient(180deg, #4da3ff 0%, #0a6ed1 100%);
      color: white; font-size:12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    button.secondary{ background: linear-gradient(180deg, #ffffff 0%, #dfeaf6 100%); border-color: #8aa6c7; color: var(--text); }
    button.success{ background: linear-gradient(180deg, #4fd18f 0%, #1b8e5a 100%); border-color:#1b8e5a; }
    button.danger{ background: linear-gradient(180deg, #e56b6b 0%, #c73535 100%); border-color:#a02b2b; }
    button.warn{ background: linear-gradient(180deg, #ffd46b 0%, #e0a100 100%); border-color:#b98600; color:#2b1a00; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    table{
      width: 100%; border-collapse: collapse; margin-top: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
      background:#fff;
    }
    th, td{
      text-align:left; padding: 7px 8px; border: 1px solid var(--border);
      vertical-align: middle;
    }
    th{ background: linear-gradient(180deg, #eef5ff 0%, #d7e6f7 100%); color: #0b1d33; font-weight: 800; }
    tr:hover td{ background: #f0f7ff; }
    .empty{ color: var(--muted); font-size: 12px; padding-top: 8px; }

    .split{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 1000px){ .split{ grid-template-columns: 1fr; } }

    .status{ margin-left:auto; color: var(--muted); font-size: 11px; }
    .status strong{ color: var(--text); }
    .nowrap{ white-space: nowrap; }
    .right{ text-align:right; }
    .center{ text-align:center; }
    .bold{ font-weight:700; }

    .tab-panel[hidden]{ display:none; }
    .divider{ height:1px; background: #aac0dd; margin: 12px 0; }

    .info{
      border: 1px solid #a9bfdc; background: #f2f7ff;
      padding: 8px 10px; border-radius: 4px;
      color: var(--muted); font-size: 11px; line-height: 1.35; margin-top: 8px;
    }

    .modal-backdrop{
      position:fixed; inset:0; background: rgba(8,32,64,.35);
      display:none; align-items:center; justify-content:center;
      padding: 18px; z-index: 50;
    }
    .modal{
      width: min(1100px, 100%); background: #ffffff;
      border: 1px solid #8aa6c7; border-radius: 6px;
      padding: 12px; box-shadow: 0 18px 40px rgba(0,0,0,.25);
      max-height: 88vh; overflow:auto;
    }
    .modal-header{ display:flex; gap:8px; align-items:flex-start; justify-content:space-between; margin-bottom: 10px; }
    .modal-title{ margin:0; font-size: 14px; font-weight:800; color: #0b1d33; text-transform: uppercase; }
    .modal-sub{ margin:3px 0 0; color: var(--muted); font-size: 11px; }
    .modal-close{ padding: 7px 9px; }

    .gran-input{ width: 120px; text-align:right; }

    .print-sheet{
      display: grid; gap: 10px;
      border: 1px solid #000;
      padding: 10px;
      background: #fff;
    }
    .print-header{
      display:grid; grid-template-columns: 1fr 1fr; align-items:center;
      text-align:center; gap: 6px;
    }
    .print-title-top{ font-size:12px; font-weight:800; text-transform: uppercase; }
    .print-title-main{ font-size:22px; font-weight:900; }
    .print-title-sub{ font-size:13px; font-weight:700; text-transform: uppercase; margin-top:2px; }

    .box-outline{
      border: 1px solid #000; padding: 6px 8px; border-radius: 2px; background:#fff;
    }
    .box-outline input{
      border: 1px solid #000; border-radius: 0; height: 26px; font-weight:700; text-align:center;
    }

    .table-thin th, .table-thin td{ border:1px solid #000; }
    .table-compact th, .table-compact td{ padding: 6px 6px; font-size:12px; }
    .table-tight th, .table-tight td{ padding: 5px 5px; font-size:11.5px; }

    .section-title{
      font-weight:900; text-transform: uppercase; margin: 6px 0 4px;
    }

    .editing-cell{
      background: #fff3c9;
      outline: 1px dashed #c9a000;
    }

    .chart-legend{
      display:flex;
      gap:12px;
      align-items:center;
      font-size:11px;
      color:var(--muted);
      margin:6px 0 10px;
    }
    .legend-line{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .legend-swatch{
      width:18px;
      height:3px;
      border-radius:2px;
    }
    .legend-retido{ background:#0a6ed1; }
    .legend-acum{ background:#e07b00; }
    .legend-mix{ background:#0a6e6e; }

    .chart-container{
      width:100%;
      overflow:auto;
      background:#fff;
      border:1px solid #8aa6c7;
      border-radius:4px;
      padding:8px;
    }
    .chart-svg{
      width:100%;
      min-width:600px;
      height:320px;
    }
    .chart-title{
      font-weight:800;
      font-size:12px;
      color:#0b1d33;
      margin-bottom:6px;
    }

    @media print{
      @page { size: A4 portrait; margin: 3mm; }
      html, body { width: 210mm; height: 297mm; }
      body{
        background: #ffffff;
        font-size: 9px;
        line-height: 1.0;
      }

      header, .toolbar, .no-print{ display:none !important; }
      main{ max-width: 100%; padding: 0; }

      #panelTraco > .card:not(.print-sheet){ display:none !important; }
      .print-sheet .card{ display:none !important; }

      .card, .print-sheet, table, tr, td, th{ page-break-inside: avoid; }
      .card.print-sheet{ page-break-after: avoid; }

      .print-sheet{
        gap: 4px;
        padding: 5px;
        border: 1px solid #000;
      }

      .divider{ margin: 4px 0; }
      .grid-3{ gap: 4px; }
      .split{ gap: 4px; }

      .box-outline{ padding: 3px 5px; }
      .box-outline input{
        height: 18px;
        font-size: 9px;
      }

      table{ font-size: 9px; }
      th, td{ padding: 3px 4px; }

      .table-compact th, .table-compact td{
        padding: 3px 3px;
        font-size: 9px;
      }
      .table-tight th, .table-tight td{
        padding: 2px 3px;
        font-size: 8.5px;
      }

      .print-title-top{ font-size:9px; }
      .print-title-main{ font-size:14px; }
      .print-title-sub{ font-size:9px; }

      input, select, textarea{ border:1px solid #000; font-size:9px; }
      textarea{ min-height: 32px; }

      .row{ margin-top: 4px; gap: 4px; }
    }

    /* ====== HISTÓRICO — SAP-like compact table + filter ====== */
    .sap-toolbar{
      display:flex; gap:8px; align-items:center; margin:8px 0 10px; flex-wrap:wrap;
    }
    .sap-filter{
      display:flex; gap:6px; align-items:center; background:#fff; border:1px solid #bfcfe6; padding:6px 8px; border-radius:4px;
    }
    .sap-filter input{ width:280px; padding:6px 8px; border:1px solid #cfe0f5; border-radius:4px; }
    .sap-view-btn{
      padding:8px 10px; border-radius:4px; border:1px solid #8aa6c7; background: linear-gradient(180deg,#fff,#eaf4ff); cursor:pointer; font-weight:700;
    }
    .sap-view-btn.active{ background: linear-gradient(180deg,#dbe9f8,#b6cdea); border-color:#1f4e8c; color:#07203a; }
    .sap-table{ display:block; margin-top:10px; border:1px solid #bfcfe6; border-radius:4px; overflow:auto; background:#f7fbff; padding:6px; }
    .sap-table table{ border: none; width:100%; }
    .sap-table th{ background: linear-gradient(180deg,#e9f5ff,#d2e8fb); border:1px solid #c3d7ee; padding:8px 10px; font-weight:700; color:#0b2a4a; }
    .sap-table td{ background:#fff; border:1px solid #e1ecf7; padding:8px 10px; color:#163a55; }
    .sap-table tr:nth-child(odd) td{ background:#fbfeff; }
    .sap-empty{ padding:12px; color:var(--muted); background:#fff; border:1px solid #e1ecf7; }

    /* ====== ICON BUTTONS (small edit/delete) ====== */
    .icon-btn{
      width:30px;
      height:28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px;
      border-radius:4px;
      border:1px solid rgba(138,166,199,0.6);
      background:#ffffff;
      color:var(--muted);
      cursor:pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .icon-btn svg{ width:14px; height:14px; display:block; }
    .icon-btn.icon-edit{ border-color: rgba(170,190,220,0.9); background: linear-gradient(180deg,#fff,#eef6ff); color:#0a6ed1; }
    .icon-btn.icon-delete{ border-color: rgba(225,160,160,0.9); background: linear-gradient(180deg,#fff,#fff0f0); color:#c73535; }
    .icon-btn:hover{ transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.08); }
    .row .icon-btn{ margin-left:4px; }
    /* make the actions column compact */
    .nowrap .icon-actions{ display:flex; gap:6px; align-items:center; justify-content:flex-end; }
  </style>
</head>
<body>
<header>
  <h1>CPTec</h1>
  <p>Abas: Clientes, Insumos, Características, Traço/Impressão, Histórico e Corrigido. Dados salvos no navegador (localStorage). M.E em g/cm³.</p>

  <!-- Adicione o arquivo de logo ao mesmo diretório e nomeie como "logo-cptec.png" ou ajuste o src -->
  <img class="header-logo" id="brandLogo" src="logo-cptec.png" alt="CPTec logo" />
</header>

<main id="appMain" style="display:none;">
  <section class="toolbar" aria-label="Barra superior">
    <div class="tabs" role="tablist" aria-label="Abas">
      <button class="tab-btn" role="tab" id="tabClientes" aria-controls="panelClientes" aria-selected="true" type="button">Clientes</button>
      <button class="tab-btn" role="tab" id="tabInsumos" aria-controls="panelInsumos" aria-selected="false" type="button">Insumos</button>
      <button class="tab-btn" role="tab" id="tabCaracteristicas" aria-controls="panelCaracteristicas" aria-selected="false" type="button">Características</button>
      <button class="tab-btn" role="tab" id="tabTraco" aria-controls="panelTraco" aria-selected="false" type="button">Traço / Impressão</button>
      <button class="tab-btn" role="tab" id="tabHistorico" aria-controls="panelHistorico" aria-selected="false" type="button">Histórico</button>
      <button class="tab-btn" role="tab" id="tabCorrigido" aria-controls="panelCorrigido" aria-selected="false" type="button">Corrigido</button>
    </div>
    <div class="pill">Cliente: <strong id="uiClienteSel">Nenhum</strong></div>
    <div class="pill">Insumo: <strong id="uiInsumoSel">Nenhum</strong></div>
    <div class="topbar-user">
      <span class="badge" id="loggedUserBadge">—</span>
      <button type="button" class="secondary" id="adminUsersBtn" hidden>Admin: Usuários</button>
      <button type="button" class="secondary" id="logoutBtn">Sair</button>
    </div>
  </section>

  <!-- Clientes -->
  <section id="panelClientes" class="tab-panel" role="tabpanel" aria-labelledby="tabClientes">
    <div class="split">
      <div class="card">
        <h2>Cadastro do cliente</h2>
        <form id="clienteForm">
          <div class="grid">
            <div><label for="empresa">Nome da empresa *</label><input id="empresa" required /></div>
            <div>
              <label for="segmento">Segmento *</label>
              <select id="segmento" required>
                <option value="" selected disabled>Selecione...</option>
                <option value="usina">usina</option>
                <option value="pre-fabricados">pre-fabricados</option>
                <option value="artefatos">artefatos</option>
                <option value="obra">obra</option>
                <option value="outros">outros</option>
              </select>
            </div>
            <div class="grid-1" style="grid-column: 1 / -1;"><label for="endereco">Endereço *</label><input id="endereco" required /></div>
            <div><label for="telefone">Contato telefônico *</label><input id="telefone" type="tel" required /></div>
            <div><label for="email">E-mail *</label><input id="email" type="email" required /></div>
          </div>
          <div class="row">
            <button type="submit" class="success">Salvar cliente</button>
            <button type="button" class="secondary" id="limparClienteBtn">Limpar</button>
            <button type="button" class="secondary" id="irParaInsumosBtn" disabled>Ir para Insumos</button>
          </div>
          <p class="hint">Ao salvar, o cliente fica selecionado automaticamente.</p>
        </form>
      </div>

      <div class="card">
        <h2>Clientes cadastrados</h2>
        <div class="row" style="margin-top:0;">
          <button type="button" class="secondary" id="desselecionarClienteBtn">Desselecionar</button>
          <button type="button" class="danger" id="removerClienteBtn" disabled>Remover selecionado</button>
          <button type="button" class="danger" id="limparTudoBtn">Apagar tudo</button>
        </div>
        <table aria-label="Tabela de clientes">
          <thead><tr><th>Empresa</th><th>Segmento</th><th>Contato</th></tr></thead>
          <tbody id="clientesTbody"></tbody>
        </table>
        <div class="empty" id="clientesEmpty" hidden>Nenhum cliente cadastrado.</div>
        <p class="hint">Clique numa linha para selecionar.</p>
      </div>
    </div>
  </section>

  <!-- Insumos -->
  <section id="panelInsumos" class="tab-panel" role="tabpanel" aria-labelledby="tabInsumos" hidden>
    <div class="split">
      <div class="card">
        <h2>Cadastro de insumo (por cliente)</h2>
        <p class="hint" style="margin-top:0;">Cliente selecionado: <strong id="insumosClienteNome">Nenhum</strong></p>
        <form id="insumoForm">
          <div class="grid">
            <div><label for="insumo">Insumo *</label><input id="insumo" required /></div>
            <div><label for="tipo">Tipo *</label><input id="tipo" required /></div>
            <div class="grid-1" style="grid-column: 1 / -1;"><label for="fornecedor">Fornecedor *</label><input id="fornecedor" required /></div>
            <!-- NEW: custo do insumo -->
            <div><label for="valorKg">Custo (R$/kg)</label><input id="valorKg" type="number" step="0.01" min="0" /></div>
          </div>
          <div class="row">
            <button type="submit" class="success" id="salvarInsumoBtn" disabled>Salvar insumo</button>
            <button type="button" class="secondary" id="limparInsumoBtn" disabled>Limpar</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h2>Insumos do cliente</h2>
        <div class="row" style="margin-top:0;">
          <button type="button" class="secondary" id="irParaCaracteristicasBtn" disabled>Ir para Características</button>
        </div>
        <table aria-label="Tabela de insumos">
          <thead>
            <tr>
              <th>Insumo / Tipo / Fornecedor</th>
              <th class="nowrap">M.E (g/cm³)</th>
              <th class="nowrap">MF</th>
              <th class="nowrap">Custo (R$/kg)</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="insumosTbody"></tbody>
        </table>
        <div class="empty" id="insumosEmpty" hidden>Nenhum insumo cadastrado para este cliente.</div>
      </div>
    </div>
  </section>

  <!-- Características -->
  <section id="panelCaracteristicas" class="tab-panel" role="tabpanel" aria-labelledby="tabCaracteristicas" hidden>
    <div class="card">
      <h2>Características (insumo selecionado)</h2>
      <div class="row" style="margin-top:0;">
        <div class="pill">Cliente: <strong id="carClienteNome">Nenhum</strong></div>
        <div class="pill">Insumo: <strong id="carInsumoNome">Nenhum</strong></div>
        <button type="button" class="warn" id="abrirModalCarBtn" disabled>Abrir editor</button>
      </div>
      <div class="info">Confirmar entrada de massa retida: Enter ou ao sair do campo. MF calculado segundo NBR 7211 (soma dos % acumulados nas peneiras 4,8 → 0,15 ÷ 100).</div>
    </div>
  </section>

  <!-- Traço + Impressão unificados -->
  <section id="panelTraco" class="tab-panel" role="tabpanel" aria-labelledby="tabTraco" hidden>
    <div class="card">
      <h2>Traço - Montagem e cálculo</h2>

      <div class="grid">
        <div>
          <label for="trCliente">Cliente</label>
          <select id="trCliente"></select>
          <p class="hint">Atualiza conforme clientes cadastrados.</p>
        </div>
        <div>
          <label for="trVolume">Volume desejado (m³)</label>
          <input id="trVolume" type="number" step="0.01" min="0" value="1" />
        </div>
        <div>
          <label for="trTitulo">Título do estudo</label>
          <input id="trTitulo" placeholder="Ex: Comparativo CP II x CP V" />
        </div>
        <div>
          <label for="trData">Data do estudo</label>
          <input id="trData" type="date" />
        </div>
      </div>

      <div class="divider"></div>
      <h2 style="margin-top:0;">Entradas</h2>
      <div class="grid-3">
        <div><label for="inArgamassa">Argamassa (%)</label><input id="inArgamassa" type="number" step="0.1" min="0" max="100" value="53.7" /></div>
        <div><label for="inAC">Relação A/C</label><input id="inAC" type="number" step="0.01" min="0" value="0.50" /></div>
        <div><label for="inAr">Ar incorporado (%)</label><input id="inAr" type="number" step="0.1" min="0" max="30" value="2.0" /></div>
        <div><label for="inH">Água na mistura H (%)</label><input id="inH" type="number" step="0.1" min="0" max="40" value="9.7" /></div>
        <div><label for="inAdicaoPct">Adição (%) (sobre cimento)</label><input id="inAdicaoPct" type="number" step="0.01" min="0" value="0.0" /></div>
        <div><label for="inAditivo1Pct">Aditivo 1 (%)</label><input id="inAditivo1Pct" type="number" step="0.01" min="0" value="0.5" /></div>
        <div><label for="inAditivo2Pct">Aditivo 2 (%)</label><input id="inAditivo2Pct" type="number" step="0.01" min="0" value="0.5" /></div>
      </div>
      <div class="divider"></div>
      <h2 style="margin-top:0;">Materiais (insumos do cliente)</h2>
      <div class="grid-3">
        <div><label for="matCimento">Cimento</label><select id="matCimento"></select></div>
        <div><label for="matAdicao">Adição</label><select id="matAdicao"></select></div>
        <div><label for="matAgua">Água</label><select id="matAgua"></select></div>
        <div><label for="matAreia1">Areia 1</label><select id="matAreia1"></select></div>
        <div><label for="matAreia2">Areia 2</label><select id="matAreia2"></select></div>
        <div><label for="matAreia3">Areia 3</label><select id="matAreia3"></select></div>
        <div><label for="matBrita0">Brita 0</label><select id="matBrita0"></select></div>
        <div><label for="matBrita12">Brita 1/2</label><select id="matBrita12"></select></div>
        <div><label for="matBrita1">Brita 1</label><select id="matBrita1"></select></div>
        <div><label for="matAditivo1">Aditivo 1</label><select id="matAditivo1"></select></div>
        <div><label for="matAditivo2">Aditivo 2</label><select id="matAditivo2"></select></div>
      </div>
      <div class="divider"></div>
      <h2 style="margin-top:0;">Proporções (%)</h2>
      <div class="grid">
        <div class="card" style="box-shadow:none; border:1px dashed #bdbdbd;">
          <h2>Areias (soma = 100%)</h2>
          <div class="grid">
            <div><label for="pctAreia1">% Areia 1</label><input id="pctAreia1" type="number" step="0.1" min="0" value="40" /></div>
            <div><label for="pctAreia2">% Areia 2</label><input id="pctAreia2" type="number" step="0.1" min="0" value="30" /></div>
            <div><label for="pctAreia3">% Areia 3</label><input id="pctAreia3" type="number" step="0.1" min="0" value="30" /></div>
          </div>
          <p class="hint" id="areiasSumHint">Soma: —</p>
        </div>
        <div class="card" style="box-shadow:none; border:1px dashed #bdbdbd;">
          <h2>Britas (soma = 100%)</h2>
          <div class="grid">
            <div><label for="pctBrita0">% Brita 0</label><input id="pctBrita0" type="number" step="0.1" min="0" value="30" /></div>
            <div><label for="pctBrita12">% Brita 1/2</label><input id="pctBrita12" type="number" step="0.1" min="0" value="40" /></div>
            <div><label for="pctBrita1">% Brita 1</label><input id="pctBrita1" type="number" step="0.1" min="0" value="30" /></div>
          </div>
          <p class="hint" id="britasSumHint">Soma: —</p>
        </div>
      </div>
      <div class="row">
        <button type="button" class="success" id="calcTracoBtn">Calcular traço</button>
        <button type="button" class="warn" id="salvarTracoBtn">Salvar / Inserir traço</button>
        <span class="status">Resultado: <strong id="tracoStatus">—</strong></span>
      </div>
      <div class="divider"></div>
      <h2 style="margin-top:0;">Resultados</h2>
      <div class="grid-3">
        <div><label>m</label><input id="outM" disabled /></div>
        <div><label>a</label><input id="outA" disabled /></div>
        <div><label>b</label><input id="outB" disabled /></div>
        <div><label>Cc (kg/m³)</label><input id="outCc" disabled /></div>
      </div>
      <div class="info">
        m = (A/C ÷ H) − (1 + Adição) &nbsp; • a = Argamassa × ((1 + Adição) + m) − (1 + Adição) &nbsp; • b = m − a &nbsp; • Cc = (1000 × (1 − Ar)) ÷ Σ(Di/Bi)
      </div>

      <!-- Mix granulometry chart for the trace (dry) — NO NBR BANDS HERE (user request) -->
      <div class="divider"></div>
      <h2 style="margin-top:0;">Curva do traço (granulometria estimada do traço seco)</h2>
      <div class="chart-legend">
        <span class="legend-line"><span class="legend-swatch legend-retido"></span> % Retido (individual, mix)</span>
        <span class="legend-line"><span class="legend-swatch legend-acum"></span> % Retido (acumulado, mix)</span>
      </div>
      <div class="chart-container">
        <div class="chart-title" id="mixChartTitle">—</div>
        <svg id="tracoMixChartSvg" class="chart-svg" viewBox="0 0 600 320"></svg>
      </div>

      <table aria-label="Tabela de traço">
        <thead>
          <tr>
            <th>Material</th>
            <th class="nowrap">M.E</th>
            <th class="nowrap">MF</th>
            <th class="right nowrap">Traço unitário</th>
            <th class="right nowrap">Traço 1 m³ (kg)</th>
            <th class="right nowrap">Traço p/ Volume (kg)</th>
          </tr>
        </thead>
        <tbody id="tracoTbody"></tbody>
      </table>
      <div class="empty" id="tracoEmpty">Clique em “Calcular traço” para gerar a tabela.</div>

      <div class="divider"></div>
      <h2 style="margin-top:0;">Traços salvos</h2>
      <table aria-label="Tabela de traços salvos">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Título do estudo</th>
            <th>Data</th>
            <th>Insumos</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tracosSalvosTbody"></tbody>
      </table>
      <div class="empty" id="tracosSalvosEmpty">Nenhum traço salvo.</div>
    </div>

    <!-- Impressão -->
    <div class="card print-sheet" style="margin-top:14px;">
      <div class="print-header">
        <div>
          <div class="print-title-top">ABNT NBR 12821 - Preparação de concreto em laboratório</div>
          <div class="print-title-main"></div>
        </div>
        <div></div>
      </div>

      <div class="row no-print" style="margin-top:6px; justify-content:flex-start;">
        <button type="button" class="success" id="printPdfBtn">Gerar PDF</button>
        <button type="button" class="warn" id="saveTraceBtn">Salvar traço (histórico)</button>
      </div>

      <div class="print-grid-3" style="margin-top:6px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div class="center">
          <div class="bold" style="font-size:13px;">PEDIDO Nº</div>
          <div class="box-outline"><input id="printPedido" data-print-key="pedido" placeholder="-" /></div>
        </div>
        <div class="center">
          <div class="bold" style="font-size:13px;">DATA</div>
          <div class="box-outline"><input id="printData" data-print-key="data" type="date" /></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="split">
        <div>
          <div class="box-outline" style="margin-bottom:8px;">
            <div class="section-title">Características da dosagem:</div>
            <table class="table-compact table-thin">
              <tbody>
                <tr><td>Fck (MPa)</td><td class="right"><input data-print-key="fck" placeholder="-" /></td></tr>
                <tr><td>Abatimento (mm)</td><td class="right"><input data-print-key="abatimento" placeholder="S100" /></td></tr>
                <tr><td>Britas</td><td class="right"><input data-print-key="britas" placeholder="B-1" /></td></tr>
                <tr><td>Volume (l)</td><td class="right"><input data-print-key="volumeL" placeholder="15" /></td></tr>
              </tbody>
            </table>
          </div>

          <div class="box-outline">
            <div class="section-title">Características do concreto fresco:</div>
            <table class="table-compact table-thin">
              <tbody>
                <tr><td>Hora Início</td><td class="right"><input data-print-key="horaInicio" placeholder="16:35:00" /></td></tr>
                <tr><td>Temperatura ambiente (ºC)</td><td class="right"><input data-print-key="tempAmb" placeholder="32" /></td></tr>
                <tr><td>Umidade ambiente (%)</td><td class="right"><input data-print-key="umidAmb" placeholder="67" /></td></tr>
                <tr><td>Temperatura do concreto (ºC)</td><td class="right"><input data-print-key="tempConc" placeholder="31,5" /></td></tr>
                <tr><td>Ar Incorporado (%)</td><td class="right"><input id="printArInc" disabled /></td></tr>
                <tr><td>M.E (g/cm³)</td><td class="right"><input data-print-key="meConc" placeholder="2491,000" /></td></tr>
                <tr><td>M.Total (Kg)</td><td class="right"><input data-print-key="mTotal" placeholder="-" /></td></tr>
                <tr><td>NBR NM 67 ST e NBR 15823-2 SF</td><td class="right"><input data-print-key="slump" placeholder="165" /></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="box-outline">
          <div class="section-title center">Informação dos Materiais:</div>
          <table class="table-compact table-thin" id="printMateriaisInfo">
            <thead>
              <tr>
                <th>Material</th>
                <th>Descrição</th>
                <th class="right nowrap">Teor</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="divider"></div>

      <div class="box-outline">
        <table class="table-tight table-thin" id="printDosagemTable">
          <thead>
            <tr>
              <th rowspan="2">Material</th>
              <th rowspan="2" class="center">Materiais secos<br>Dosagem 1m³ (kg)</th>
              <th rowspan="2" class="center">Proporção<br>(%)</th>
              <th rowspan="2" class="center">Umidade</th>
              <th rowspan="2" class="center">Traço corrigido<br>1 m³</th>
            </tr>
          </thead>
          <tbody id="printDosagemTbody"></tbody>
        </table>
      </div>

      <div class="divider"></div>

      <div class="grid-3">
        <div class="box-outline center">
          <div class="bold">a/c</div>
          <input id="printAC" disabled />
          <div style="margin-top:6px;">a/c real</div>
          <input id="printACReal" disabled />
        </div>
        <div class="box-outline center">
          <div class="bold">a/agl</div>
          <input id="printAagl" disabled />
        </div>
        <div class="box-outline center">
          <div class="bold">K</div>
          <input id="printK" disabled />
        </div>
      </div>

      <div class="grid-3" style="margin-top:8px;">
        <div></div>
        <div class="box-outline center">
          <div class="bold">H</div>
          <input id="printH" disabled />
          <div style="margin-top:6px;">(H) Real</div>
          <input id="printHReal" disabled />
        </div>
        <div></div>
      </div>

      <div class="divider"></div>

      <div class="split">
        <div class="box-outline" style="max-width:360px;">
          <table class="table-compact table-thin">
            <tbody>
              <tr><td>Água Adicionada</td><td class="right"><input data-print-key="aguaAdicionada" /></td></tr>
              <tr><td>Água Retida</td><td class="right"><input data-print-key="aguaRetida" /></td></tr>
              <tr><td>Água Inicial P/ m³</td><td class="right"><input id="printAguaInicial" disabled /></td></tr>
              <tr><td>Slump Após 15 min</td><td class="right"><input data-print-key="slump15" /></td></tr>
              <tr><td>Água P/correção</td><td class="right"><input data-print-key="aguaCorrecao" /></td></tr>
              <tr><td>Slump Corrigido</td><td class="right"><input data-print-key="slumpCorrigido" /></td></tr>
              <tr><td>Água Final m³</td><td class="right"><input id="printAguaFinal" disabled /></td></tr>
            </tbody>
          </table>
        </div>
        <div class="box-outline" style="border:none; background:#fff;">
          <div class="section-title">Observações</div>
          <textarea data-print-key="observacoes" rows="7" style="width:100%; border:1px solid #000; border-radius:0;"></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <div class="box-outline">
        <table class="table-tight table-thin">
          <thead>
            <tr>
              <th>Idades</th>
              <th>Data Ruptura</th>
              <th class="right">NBR 5739 - Compressão (MPa)</th>
              <th class="right">AASHTO T-358-17</th>
              <th class="right">NBR 12142 - Tração na flexão (MPa)</th>
              <th class="right">Evolução (%)</th>
            </tr>
          </thead>
          <tbody id="printResistenciaTbody"></tbody>
        </table>
      </div>

      <div class="grid-3">
        <div class="box-outline"><label>Pesagem</label><input data-print-key="pesagem" /></div>
        <div class="box-outline"><label>Conferência</label><input data-print-key="conferencia" /></div>
        <div class="box-outline"><label>Moldagem</label><input data-print-key="moldagem" /></div>
      </div>

      <div class="row no-print" style="margin-top:10px; justify-content:flex-start;">
        <button type="button" class="success" id="salvarEnsaioBtn">Inserir / Salvar dados de ensaio</button>
      </div>

    </div>
  </section>

  <!-- HISTÓRICO (SAP-like layout) -->
  <section id="panelHistorico" class="tab-panel" role="tabpanel" aria-labelledby="tabHistorico" hidden>
    <div class="card" style="border:1px dashed #bdbdbd; box-shadow:none;">
      <h2>Histórico de traços salvos (local, editável)</h2>
      <div class="info no-print">Armazenado em localStorage. Células editáveis; ao sair do foco, salvam.</div>

      <!-- SAP-like toolbar: view buttons + global filter -->
      <div class="sap-toolbar no-print" style="margin-top:10px;">
        <div class="sap-filter" role="search" aria-label="Filtrar histórico">
          <label for="histFilterInput" style="font-weight:700; color:var(--muted); margin-right:6px;">Filtrar</label>
          <input id="histFilterInput" placeholder="Pesquisar por Nº traço, cliente, insumo..." />
          <button type="button" class="secondary" id="histClearFilterBtn">Limpar</button>
        </div>

        <div style="margin-left:auto; display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" class="sap-view-btn active" id="histViewInsumosBtn">Insumos</button>
          <button type="button" class="sap-view-btn" id="histViewQuantBtn">Quantidades</button>
          <button type="button" class="sap-view-btn" id="histViewResultadosBtn">Resultados</button>
          <button type="button" class="sap-view-btn" id="histViewFormBtn">Formulário</button>
        </div>
      </div>

      <div class="row no-print" style="margin-top:8px;">
        <button type="button" class="secondary" id="exportClientesInsumosBtn">Exportar clientes + insumos (CSV)</button>
        <button type="button" class="secondary" id="exportHistInsumosBtn">Exportar histórico: Insumos (CSV)</button>
        <button type="button" class="secondary" id="exportHistQuantBtn">Exportar histórico: Quantidades (CSV)</button>
        <button type="button" class="secondary" id="exportHistResultadosBtn">Exportar histórico: Resultados (CSV)</button>
        <button type="button" class="secondary" id="exportHistFormBtn">Exportar histórico: Formulário (CSV)</button>
      </div>

      <!-- Wrapped tables (same tbodies ids as before, kept for JS compatibility) -->
      <div id="histInsumosWrap" class="sap-table" aria-hidden="false">
        <h3 style="margin:6px 0;">1) Insumos (horizontal)</h3>
        <table>
          <thead>
            <tr>
              <th>Nº traço</th><th>Cliente</th>
              <th>Cimento</th><th>Adição</th>
              <th>Areia 1</th><th>Areia 2</th><th>Areia 3</th>
              <th>Brita 0</th><th>Brita 1/2</th><th>Brita 1</th>
              <th>Água</th><th>Aditivo 1</th><th>Aditivo 2</th>
              <th>Ações</th>
            </tr>
          </thead>
        </table>
        <div id="histInsumosTable" style="overflow:auto;">
          <table><tbody id="histInsumosTbody"></tbody></table>
        </div>
      </div>

      <div id="histQuantWrap" class="sap-table" aria-hidden="true" style="display:none;">
        <h3 style="margin:6px 0;">2) Quantidades (horizontal)</h3>
        <table>
          <thead>
            <tr>
              <th>Nº traço</th><th>Cliente</th>
              <th>Cimento</th><th>Adição</th>
              <th>Areia 1</th><th>Areia 2</th><th>Areia 3</th>
              <th>Brita 0</th><th>Brita 1/2</th><th>Brita 1</th>
              <th>Água</th><th>Aditivo 1</th><th>Aditivo 2</th>
              <th>Ações</th>
            </tr>
          </thead>
        </table>
        <div id="histQuantTable" style="overflow:auto;">
          <table><tbody id="histQuantTbody"></tbody></table>
        </div>
      </div>

      <div id="histResultadosWrap" class="sap-table" aria-hidden="true" style="display:none;">
        <h3 style="margin:6px 0;">3) Resultados obtidos (horizontal)</h3>
        <table>
          <thead>
            <tr>
              <th>Nº traço</th><th>Cliente</th><th>Data do estudo</th>
              <th>1 dia</th><th>3 dias</th><th>7 dias</th><th>14 dias</th>
              <th>28 dias</th><th>56 dias</th><th>63 dias</th>
              <th>Ações</th>
            </tr>
          </thead>
        </table>
        <div id="histResultadosTable" style="overflow:auto;">
          <table><tbody id="histResultadosTbody"></tbody></table>
        </div>
      </div>

      <div id="histFormWrap" class="sap-table" aria-hidden="true" style="display:none;">
        <h3 style="margin:6px 0;">4) Formulário (snapshot, horizontal)</h3>
        <table>
          <thead><tr>
            <th>Nº traço</th><th>Cliente</th><th>Data</th><th>Slump</th><th>Slump 15</th><th>Slump corr.</th>
            <th>Água add.</th><th>Água retida</th><th>Temp conc.</th><th>Temp amb.</th><th>Umid. amb.</th><th>Volume (m³)</th><th>Volume lab (m³)</th>
            <th>Ações</th>
          </tr></thead>
        </table>
        <div id="histFormTable" style="overflow:auto;">
          <table><tbody id="histFormTbody"></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <!-- CORRIGIDO: new tab to compute corrected trace based on historical snapshots -->
  <section id="panelCorrigido" class="tab-panel" role="tabpanel" aria-labelledby="tabCorrigido" hidden>
    <div class="card">
      <h2>Traço Corrigido (NBR 9833) — cálculo e armazenamento</h2>
      <div class="info">Selecione um traço do histórico (ou filtre) e informe a densidade do concreto (g/cm³). O cálculo usa água corrigida (Água inicial + Água adicionada - Água retida) conforme formulário do histórico.</div>

      <div class="grid">
        <div>
          <label for="corrHistFilter">Filtrar histórico</label>
          <input id="corrHistFilter" placeholder="Pesquisar Nº traço, cliente..." />
        </div>
        <div>
          <label for="corrSelectTraco">Selecionar traço histórico</label>
          <select id="corrSelectTraco" size="4" style="height:120px;"></select>
        </div>
        <div>
          <label for="corrDensity">Densidade do concreto (g/cm³)</label>
          <input id="corrDensity" type="number" step="0.001" min="0.5" value="2.45" />
        </div>
        <div>
          <label for="corrNote">Observações</label>
          <input id="corrNote" placeholder="Observação opcional..." />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button type="button" class="success" id="calcCorrigidoBtn">Calcular traço corrigido</button>
        <button type="button" class="warn" id="saveCorrigidoBtn">Salvar traço corrigido</button>
        <button type="button" class="secondary" id="clearCorrigidoBtn">Limpar seleção</button>
        <span class="status">Status: <strong id="corrStatus">—</strong></span>
      </div>

      <div class="divider"></div>

      <div class="grid-3">
        <div class="card" style="box-shadow:none;">
          <h3>Rendimento (R)</h3>
          <input id="corrR" disabled />
        </div>
        <div class="card" style="box-shadow:none;">
          <h3>Consumo de cimento (C) (kg/m³)</h3>
          <input id="corrC" disabled />
        </div>
        <div class="card" style="box-shadow:none;">
          <h3>Volume total (Vt) (m³)</h3>
          <input id="corrVt" disabled />
        </div>
      </div>

      <div class="grid-3" style="margin-top:8px;">
        <div class="card" style="box-shadow:none;">
          <h3>Índice de ar (Ia)</h3>
          <input id="corrIa" disabled />
        </div>
        <div class="card" style="box-shadow:none;">
          <h3>Teor de ar (A) (%)</h3>
          <input id="corrA" disabled />
        </div>
        <div class="card" style="box-shadow:none;">
          <h3>Relação A/C (corrigido)</h3>
          <input id="corrAC" disabled />
        </div>
      </div>

      <div class="divider"></div>

      <h3>Traço corrigido — Dosagens (kg / 1 m³ corrigido)</h3>
      <div class="sap-table">
        <table>
          <thead>
            <tr>
              <th>Material</th><th class="right">Dosagem original (kg/m³)</th><th class="right">Dosagem corrigida (kg/m³)</th><th class="right">M.E (g/cm³)</th><th class="right">Custo R$/kg</th><th class="right">Custo R$</th>
            </tr>
          </thead>
          <tbody id="corrDosagemTbody"></tbody>
        </table>
      </div>

      <div class="divider"></div>

      <div class="grid">
        <div>
          <label for="corrCostTotal">Custo total do traço (R$)</label>
          <input id="corrCostTotal" disabled />
        </div>
        <div>
          <label for="corrResTitle">Resistências (preencher/editar)</label>
          <input id="corrResTitle" placeholder="Título/resumo (opcional)" />
        </div>
        <div>
          <label>Salvar em</label>
          <select id="corrSaveAs">
            <option value="tracosCorrigidos">Traços Corrigidos (separado)</option>
            <option value="tracosSalvos">Traços Salvos (histórico principal)</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <h3>Resistências (MPa) — editar</h3>
        <div class="grid-3" id="corrResInputs">
          <!-- inputs for RUPTURA_DIAS created dynamically -->
        </div>
      </div>

      <div class="divider"></div>

      <h3>Traços Corrigidos Salvos</h3>
      <div class="sap-table">
        <table>
          <thead><tr><th>ID</th><th>Origem</th><th>Cliente</th><th>Data</th><th>Custo (R$)</th><th>Ações</th></tr></thead>
          <tbody id="corrSavedTbody"></tbody>
        </table>
      </div>

    </div>
  </section>
</main>

<!-- Modals (same as original, kept intact) -->
<div class="modal-backdrop" id="carModalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h3 class="modal-title">Editor de características físicas</h3>
        <p class="modal-sub" id="carModalSub">—</p>
      </div>
      <button class="secondary modal-close" type="button" id="carModalCloseBtn">Fechar</button>
    </div>
    <div class="grid-3">
      <div><label for="massaEspecifica">Massa específica (g/cm³) *</label><input id="massaEspecifica" type="number" step="0.001" min="0" /></div>
      <div><label>Total massa retida (g)</label><input id="totalMassaRetida" disabled /></div>
      <div><label>Módulo de finura (MF) — NBR 7211</label><input id="mfCalculado" disabled /></div>
    </div>
    <div style="margin-top:8px;">
      <label for="valorKgModal">Custo (R$/kg)</label>
      <input id="valorKgModal" type="number" step="0.01" min="0" />
    </div>
    <div class="info">Peneiras: 25 / 19 / 12,5 / 9,5 / 6,3 / 4,8 / 2,4 / 1,2 / 0,6 / 0,3 / 0,15 / FUNDO — Enter ou blur para confirmar.</div>
    <table aria-label="Tabela de granulometria">
      <thead><tr><th>Peneira (mm)</th><th class="right">Massa retida (g)</th><th class="right">% Retido</th><th class="right">% Retido acum.</th><th class="right">% Passante</th></tr></thead>
      <tbody id="granTbody"></tbody>
      <tfoot><tr><th>FUNDO</th><th class="right"><span id="fundoMassa">—</span></th><th class="right"><span id="fundoPerc">—</span></th><th class="right"><span id="fundoAcum">—</span></th><th class="right"><span id="fundoPass">—</span></th></tr></tfoot>
    </table>
    <div class="row">
      <button type="button" class="success" id="salvarCaracteristicasBtn">Salvar características</button>
      <button type="button" class="secondary" id="resetGranBtn">Zerar massas</button>
      <span class="status">Editando: <strong id="carEditStatus">—</strong></span>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="chartModalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h3 class="modal-title">Curva granulométrica</h3>
        <p class="modal-sub" id="chartModalSub">—</p>
      </div>
      <button class="secondary modal-close" type="button" id="chartModalCloseBtn">Fechar</button>
    </div>

    <div class="chart-legend">
      <span class="legend-line"><span class="legend-swatch legend-retido"></span> % Retido (individual)</span>
      <span class="legend-line"><span class="legend-swatch legend-acum"></span> % Retido (acumulado)</span>
      <span class="legend-line"><span class="legend-swatch" style="width:18px; height:8px; background:rgba(250,200,40,0.20); border-radius:2px;"></span> Zona ótima (NBR 7211)</span>
      <span class="legend-line"><span class="legend-swatch" style="width:18px; height:8px; background:rgba(120,120,120,0.12); border-radius:2px;"></span> Zona utilizável (NBR 7211)</span>
    </div>

    <div class="chart-container">
      <div class="chart-title" id="chartTitle">—</div>
      <svg id="granChartSvg" class="chart-svg" viewBox="0 0 600 320"></svg>
    </div>
  </div>
</div>

<div class="auth-backdrop" id="authBackdrop">
  <div class="auth-card" role="dialog" aria-modal="true">
    <h2 id="authTitle">Acesso</h2>

    <div id="authLoginPanel">
      <label for="loginUser">Usuário</label>
      <input id="loginUser" autocomplete="username" />
      <label for="loginPass">Senha</label>
      <input id="loginPass" type="password" autocomplete="current-password" />
      <div class="auth-msg" id="loginMsg" aria-live="polite"></div>
      <div class="row" style="margin-top:10px;">
        <button type="button" class="success" id="loginSubmitBtn">Entrar</button>
      </div>
      <div class="auth-footer">
        Somente o administrador cadastra usuários. Para configurar o sistema, entre como <strong>admin</strong> (primeiro acesso define a senha).
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="adminUsersBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h3 class="modal-title">Admin — Usuários</h3>
        <p class="modal-sub">Cadastrar/remover usuários e trocar senha do admin (armazenado no navegador).</p>
      </div>
      <button class="secondary modal-close" type="button" id="adminUsersCloseBtn">Fechar</button>
    </div>

    <div class="card" style="box-shadow:none;">
      <h3>Cadastrar novo usuário (requer senha do admin)</h3>
      <div class="grid">
        <div>
          <label for="newUser">Novo usuário</label>
          <input id="newUser" autocomplete="off" />
        </div>
        <div>
          <label for="newUserPass">Senha do novo usuário</label>
          <input id="newUserPass" type="password" autocomplete="new-password" />
        </div>
        <div>
          <label for="newUserPass2">Confirmar senha do novo usuário</label>
          <input id="newUserPass2" type="password" autocomplete="new-password" />
        </div>
        <div>
          <label for="adminConfirmPass">Senha do ADMIN (confirmação)</label>
          <input id="adminConfirmPass" type="password" autocomplete="current-password" />
        </div>
      </div>
      <div class="auth-msg" id="adminUsersMsg" aria-live="polite"></div>
      <div class="row">
        <button type="button" class="success" id="createUserBtn">Criar usuário</button>
      </div>

      <div class="divider"></div>

      <h3>Usuários cadastrados</h3>
      <table aria-label="Tabela de usuários">
        <thead>
          <tr><th>Usuário</th><th>Ações</th></tr>
        </thead>
        <tbody id="usersTbody"></tbody>
      </table>
      <p class="hint">O usuário <strong>admin</strong> não pode ser removido.</p>

      <div class="divider"></div>

      <h3>Trocar senha do admin</h3>
      <div class="grid">
        <div>
          <label for="adminOldPass">Senha atual do admin</label>
          <input id="adminOldPass" type="password" autocomplete="current-password" />
        </div>
        <div>
          <label for="adminNewPass">Nova senha do admin</label>
          <input id="adminNewPass" type="password" autocomplete="new-password" />
        </div>
        <div>
          <label for="adminNewPass2">Confirmar nova senha do admin</label>
          <input id="adminNewPass2" type="password" autocomplete="new-password" />
        </div>
        <div></div>
      </div>
      <div class="auth-msg" id="adminPassMsg" aria-live="polite"></div>
      <div class="row">
        <button type="button" class="warn" id="changeAdminPassBtn">Trocar senha do admin</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ==========================================================================
   Main application script (updated to fix Corrigido tab issues and avoid
   infinite recursion / repeated listener registration).
   ========================================================================== */

  /* =========  AUTENTICAÇÃO LOCAL (ADMIN CRIA USUÁRIOS)  ========= */
  const AUTH_KEY = "estudo_dosagem_auth_v1";
  const ADMIN_USERNAME = "admin";

  function loadAuth(){
    try { const raw = localStorage.getItem(AUTH_KEY); return raw ? JSON.parse(raw) : { users: [], currentUser: null }; }
    catch { return { users: [], currentUser: null }; }
  }
  function saveAuth(){ localStorage.setItem(AUTH_KEY, JSON.stringify(auth)); }
  let auth = loadAuth();

  async function sha256(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  function findUser(username){
    return (auth.users||[]).find(u => u.username.toLowerCase() === String(username||"").toLowerCase());
  }
  function isAdmin(username){
    return String(username || "").toLowerCase() === ADMIN_USERNAME.toLowerCase();
  }
  function hasAdmin(){
    return !!findUser(ADMIN_USERNAME);
  }

  async function ensureAdminOnFirstLogin(username, password){
    if(!isAdmin(username)) return false;
    if(hasAdmin()) return false;

    if(!password || password.length < 4) {
      throw new Error("Primeiro acesso: defina uma senha do admin com ao menos 4 caracteres.");
    }
    const hash = await sha256(password);
    auth.users = Array.isArray(auth.users) ? auth.users : [];
    auth.users.push({ username: ADMIN_USERNAME, hash });
    auth.currentUser = ADMIN_USERNAME;
    saveAuth();
    return true;
  }

  async function loginUser(username, password){
    if(!username || !password) throw new Error("Informe usuário e senha.");

    const created = await ensureAdminOnFirstLogin(username, password);
    if(created) return;

    const u = findUser(username);
    if(!u) throw new Error("Usuário não encontrado.");
    const hash = await sha256(password);
    if(hash !== u.hash) throw new Error("Senha incorreta.");

    auth.currentUser = u.username;
    saveAuth();
  }

  function logoutUser(){
    auth.currentUser = null;
    saveAuth();
  }

  async function confirmAdminPassword(adminPassword){
    const admin = findUser(ADMIN_USERNAME);
    if(!admin) throw new Error('Admin não configurado. Faça login como "admin" para definir a senha.');
    const hash = await sha256(adminPassword || "");
    if(hash !== admin.hash) throw new Error("Senha do admin inválida.");
    return true;
  }

  async function adminCreateUser(newUsername, newPassword){
    if(!newUsername) throw new Error("Informe o nome do usuário.");
    if(isAdmin(newUsername)) throw new Error('Use o login "admin" apenas para administração.');
    if(!newPassword || newPassword.length < 4) throw new Error("Senha deve ter ao menos 4 caracteres.");
    if(findUser(newUsername)) throw new Error("Usuário já existe.");

    const hash = await sha256(newPassword);
    auth.users.push({ username: newUsername, hash });
    saveAuth();
  }

  function adminDeleteUser(username){
    if(isAdmin(username)) throw new Error("Não é permitido remover o admin.");

    const uname = String(username || "");
    auth.users = (auth.users||[]).filter(u => u.username.toLowerCase() !== uname.toLowerCase());
    saveAuth();

    if(auth.currentUser && auth.currentUser.toLowerCase() === uname.toLowerCase()){
      logoutUser();
      hideApp();
      alert("Seu usuário foi removido. Você saiu do sistema.");
    }
  }

  async function adminChangePassword(oldPass, newPass){
    const admin = findUser(ADMIN_USERNAME);
    if(!admin) throw new Error('Admin não configurado. Faça login como "admin".');

    await confirmAdminPassword(oldPass);

    if(!newPass || newPass.length < 4) throw new Error("Nova senha deve ter ao menos 4 caracteres.");
    admin.hash = await sha256(newPass);
    saveAuth();
  }

  /* =========  UI (LOGIN + MODAL ADMIN)  ========= */
  const authBackdrop = document.getElementById("authBackdrop");
  const appMain = document.getElementById("appMain");
  const loggedUserBadge = document.getElementById("loggedUserBadge");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginMsg = document.getElementById("loginMsg");
  const adminUsersBtn = document.getElementById("adminUsersBtn");

  const adminUsersBackdrop = document.getElementById("adminUsersBackdrop");
  const adminUsersCloseBtn = document.getElementById("adminUsersCloseBtn");
  const adminUsersMsg = document.getElementById("adminUsersMsg");
  const adminPassMsg = document.getElementById("adminPassMsg");
  const usersTbody = document.getElementById("usersTbody");

  function showApp(){
    authBackdrop.style.display = "none";
    appMain.style.display = "grid";
    loggedUserBadge.textContent = auth.currentUser || "—";
    adminUsersBtn.hidden = !isAdmin(auth.currentUser);
  }
  function hideApp(){
    authBackdrop.style.display = "flex";
    appMain.style.display = "none";
    loggedUserBadge.textContent = "—";
    adminUsersBtn.hidden = true;
  }

  function openAdminUsers(){
    if(!isAdmin(auth.currentUser)){
      alert("Apenas o admin pode acessar esta área.");
      return;
    }
    adminUsersMsg.textContent = "";
    adminUsersMsg.classList.remove("auth-success");
    adminPassMsg.textContent = "";
    adminPassMsg.classList.remove("auth-success");
    renderUsersTable();
    adminUsersBackdrop.style.display = "flex";
  }
  function closeAdminUsers(){
    adminUsersBackdrop.style.display = "none";
  }

  function renderUsersTable(){
    usersTbody.innerHTML = "";
    const users = Array.isArray(auth.users) ? auth.users : [];

    if(!users.length){
      const tr=document.createElement("tr");
      tr.innerHTML = `<td colspan="2">Nenhum usuário cadastrado.</td>`;
      usersTbody.appendChild(tr);
      return;
    }

    users
      .slice()
      .sort((a,b)=>a.username.localeCompare(b.username, "pt-BR", { sensitivity:"base" }))
      .forEach(u=>{
        const tr=document.createElement("tr");
        const canDelete = !isAdmin(u.username);
        // compact remove icon button
        const btnHtml = `<button type="button" class="icon-btn icon-delete" ${canDelete ? "" : "disabled"} data-user="${u.username}" title="Remover" aria-label="Remover">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
        </button>`;
        tr.innerHTML = `
          <td>${u.username}</td>
          <td class="nowrap">${btnHtml}</td>
        `;
        const btn = tr.querySelector("button");
        btn?.addEventListener("click", ()=>{ 
          const username = u.username;
          if(!canDelete) return;
          if(!confirm(`Remover o usuário "${username}"?`)) return;
          try{
            adminDeleteUser(username);
            renderUsersTable();
          }catch(err){
            alert(err.message || "Erro ao remover usuário.");
          }
        });
        usersTbody.appendChild(tr);
      });
  }

  document.getElementById("loginSubmitBtn").addEventListener("click", async ()=>{
    loginMsg.textContent = "";
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value;
    try{
      await loginUser(user, pass);
      showApp();
    }catch(err){
      loginMsg.textContent = err.message || "Erro ao entrar.";
      loginMsg.classList.remove("auth-success");
    }
  });

  logoutBtn.addEventListener("click", ()=>{
    logoutUser();
    hideApp();
  });

  adminUsersBtn?.addEventListener("click", openAdminUsers);
  adminUsersCloseBtn?.addEventListener("click", closeAdminUsers);
  adminUsersBackdrop?.addEventListener("click", (e)=>{ if(e.target===adminUsersBackdrop) closeAdminUsers(); });
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && adminUsersBackdrop?.style.display==="flex") closeAdminUsers(); });

  document.getElementById("createUserBtn")?.addEventListener("click", async ()=>{
    adminUsersMsg.textContent = "";
    adminUsersMsg.classList.remove("auth-success");

    const newUser = document.getElementById("newUser").value.trim();
    const pass1 = document.getElementById("newUserPass").value;
    const pass2 = document.getElementById("newUserPass2").value;
    const adminPass = document.getElementById("adminConfirmPass").value;

    try{
      if(pass1 !== pass2) throw new Error("As senhas do novo usuário não coincidem.");
      await confirmAdminPassword(adminPass);
      await adminCreateUser(newUser, pass1);

      adminUsersMsg.textContent = "Usuário criado com sucesso.";
      adminUsersMsg.classList.add("auth-success");

      document.getElementById("newUser").value = "";
      document.getElementById("newUserPass").value = "";
      document.getElementById("newUserPass2").value = "";
      document.getElementById("adminConfirmPass").value = "";

      renderUsersTable();
    }catch(err){
      adminUsersMsg.textContent = err.message || "Erro ao criar usuário.";
      adminUsersMsg.classList.remove("auth-success");
    }
  });

  document.getElementById("changeAdminPassBtn")?.addEventListener("click", async ()=>{
    adminPassMsg.textContent = "";
    adminPassMsg.classList.remove("auth-success");

    const oldPass = document.getElementById("adminOldPass").value;
    const newPass = document.getElementById("adminNewPass").value;
    const newPass2= document.getElementById("adminNewPass2").value;

    try{
      if(newPass !== newPass2) throw new Error("A confirmação da nova senha do admin não confere.");
      await adminChangePassword(oldPass, newPass);

      adminPassMsg.textContent = "Senha do admin alterada com sucesso.";
      adminPassMsg.classList.add("auth-success");

      document.getElementById("adminOldPass").value = "";
      document.getElementById("adminNewPass").value = "";
      document.getElementById("adminNewPass2").value = "";
    }catch(err){
      adminPassMsg.textContent = err.message || "Erro ao trocar senha do admin.";
      adminPassMsg.classList.remove("auth-success");
    }
  });

  if(auth.currentUser){
    showApp();
  }else{
    hideApp();
  }

  /* =========  LÓGICA PRINCIPAL ORIGINAL (state, helpers, traco, historico) ========= */
  const STORAGE_KEY = "estudo_dosagem_tabs_clean_final_v2";
  const RUPTURA_DIAS = [1,3,7,14,28,56,63];
  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {
        clientes:[], selectedClienteId:null, selectedInsumoId:null, activeTab:"clientes",
        printForm:{}, printRows:{}, lastTraco:null, tracosHistorico:[],
        tracosSalvos:[], ensaiosSalvos:[], selectedTracoId:null, tracosCorrigidos:[]
      };
      const parsed = JSON.parse(raw);
      return {
        clientes: Array.isArray(parsed.clientes) ? parsed.clientes : [],
        selectedClienteId: parsed.selectedClienteId ?? null,
        selectedInsumoId: parsed.selectedInsumoId ?? null,
        activeTab: parsed.activeTab || "clientes",
        printForm: parsed.printForm || {},
        printRows: parsed.printRows || {},
        lastTraco: parsed.lastTraco || null,
        tracosHistorico: Array.isArray(parsed.tracosHistorico) ? parsed.tracosHistorico : [],
        tracosSalvos: Array.isArray(parsed.tracosSalvos) ? parsed.tracosSalvos : [],
        ensaiosSalvos: Array.isArray(parsed.ensaiosSalvos) ? parsed.ensaiosSalvos : [],
        selectedTracoId: parsed.selectedTracoId ?? null,
        tracosCorrigidos: Array.isArray(parsed.tracosCorrigidos) ? parsed.tracosCorrigidos : []
      };
    } catch {
      return {
        clientes:[], selectedClienteId:null, selectedInsumoId:null, activeTab:"clientes",
        printForm:{}, printRows:{}, lastTraco:null, tracosHistorico:[],
        tracosSalvos:[], ensaiosSalvos:[], selectedTracoId:null, tracosCorrigidos:[]
      };
    }
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  let state = loadState();
  const $ = (s) => document.querySelector(s);
  const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()));

  function escapeHtml(str){ return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
  function numOr0(v){ const n=Number(String(v ?? "").replace(",", ".")); return Number.isFinite(n) ? n : 0; }
  function round(n,d=2){ if(!Number.isFinite(n)) return 0; const k=Math.pow(10,d); return Math.round(n*k)/k; }
  function fmtPt(n,d=2){ if(!Number.isFinite(n)) return "0"; return round(n,d).toLocaleString("pt-BR",{minimumFractionDigits:d, maximumFractionDigits:d}); }
  function addDays(baseDateStr, days){ if(!baseDateStr) return ""; const d=new Date(`${baseDateStr}T00:00:00`); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
  function parsePercentInput(value){ const cleaned=String(value ?? "").replace("%","").trim(); return numOr0(cleaned); }
  function formatPercentDisplay(value){ if (value===null||value===undefined||String(value).trim()==="") return ""; return `${fmtPt(numOr0(value), 2)}%`; }

  const tabs=[
    { key:"clientes", btn: $("#tabClientes"), panel: $("#panelClientes") },
    { key:"insumos", btn: $("#tabInsumos"), panel: $("#panelInsumos") },
    { key:"caracteristicas", btn: $("#tabCaracteristicas"), panel: $("#panelCaracteristicas") },
    { key:"traco", btn: $("#tabTraco"), panel: $("#panelTraco") },
    { key:"historico", btn: $("#tabHistorico"), panel: $("#panelHistorico") },
    { key:"corrigido", btn: $("#tabCorrigido"), panel: $("#panelCorrigido") },
  ];
  function setActiveTab(key){
    const valid = tabs.some(t=>t.key===key) ? key : "traco";
    state.activeTab=valid; saveState();
    tabs.forEach(t=>{ const on=t.key===valid; t.btn.setAttribute("aria-selected", on?"true":"false"); t.panel.hidden=!on; });
    if(valid==="traco") { syncTracoUI(true); renderPrintPanel(); computeAndRenderMixGran(); }
    if(valid==="historico") { renderHistorico(); }
    if(valid==="corrigido") { renderCorrigidoInit(); }
  }
  tabs.forEach(t=>t.btn.addEventListener("click",()=>setActiveTab(t.key)));

  const uiClienteSel=$("#uiClienteSel");
  const uiInsumoSel=$("#uiInsumoSel");

  const clienteForm=$("#clienteForm");
  const clientesTbody=$("#clientesTbody");
  const clientesEmpty=$("#clientesEmpty");
  const removerClienteBtn=$("#removerClienteBtn");
  const irParaInsumosBtn=$("#irParaInsumosBtn");

  const insumosClienteNome=$("#insumosClienteNome");
  const insumoForm=$("#insumoForm");
  const salvarInsumoBtn=$("#salvarInsumoBtn");
  const limparInsumoBtn=$("#limparInsumoBtn");
  const insumosTbody=$("#insumosTbody");
  const insumosEmpty=$("#insumosEmpty");
  const irParaCaracteristicasBtn=$("#irParaCaracteristicasBtn");

  const carClienteNome=$("#carClienteNome");
  const carInsumoNome=$("#carInsumoNome");
  const abrirModalCarBtn=$("#abrirModalCarBtn");

  const carModalBackdrop=$("#carModalBackdrop");
  const carModalCloseBtn=$("#carModalCloseBtn");
  const carModalSub=$("#carModalSub");
  const carEditStatus=$("#carEditStatus");
  const massaEspecificaInput=$("#massaEspecifica");
  const totalMassaRetidaInput=$("#totalMassaRetida");
  const mfCalculadoInput=$("#mfCalculado");
  const granTbody=$("#granTbody");
  const salvarCaracteristicasBtn=$("#salvarCaracteristicasBtn");
  const resetGranBtn=$("#resetGranBtn");
  const fundoMassaEl=$("#fundoMassa");
  const fundoPercEl=$("#fundoPerc");
  const fundoAcumEl=$("#fundoAcum");
  const fundoPassEl=$("#fundoPass");

  // NEW refs for custo editing
  const insumoValorInput = $("#valorKg");
  const valorKgModal = $("#valorKgModal");

  const saveTraceBtn = document.getElementById("saveTraceBtn");

  const chartModalBackdrop = document.getElementById("chartModalBackdrop");
  const chartModalCloseBtn = document.getElementById("chartModalCloseBtn");
  const chartModalSub = document.getElementById("chartModalSub");
  const granChartSvg = document.getElementById("granChartSvg");
  const chartTitle = document.getElementById("chartTitle");

  const trTitulo = document.getElementById("trTitulo");
  const trData   = document.getElementById("trData");
  if(!trData.value) trData.value = new Date().toISOString().slice(0,10);
  const trVolume = document.getElementById("trVolume");
  const salvarTracoBtn = document.getElementById("salvarTracoBtn");
  const tracosSalvosTbody = document.getElementById("tracosSalvosTbody");
  const tracosSalvosEmpty = document.getElementById("tracosSalvosEmpty");

  const salvarEnsaioBtn = document.getElementById("salvarEnsaioBtn");
  const printPdfBtn=$("#printPdfBtn");
  const printMateriaisInfo=$("#printMateriaisInfo");
  const printDosagemTbody=$("#printDosagemTbody");
  const printResistenciaTbody=$("#printResistenciaTbody");

  let modalGranMasses={};
  const SIEVES_MM=[25,19,12.5,9.5,6.3,4.8,2.4,1.2,0.6,0.3,0.15];
  const MF_SIEVES=[4.8,2.4,1.2,0.6,0.3,0.15];

  /* ================= NBR 7211 — LIMITS (kept) ========================= */
  function getNbr7211Limits(){
    const sand = {
      mm: [25,19,12.5,9.5,6.3,4.8,2.4,1.2,0.6,0.3,0.15,0],
      utilizavelLower: [0,0,0,0,0,0,0,5,15,50,85,100],
      utilizavelUpper: [0,0,0,0,7,10,25,50,70,95,100,100],
      otimaLower: [0,0,0,0,0,5,10,20,35,65,90,100],
      otimaUpper: [0,0,0,0,5,10,25,30,55,85,95,100]
    };
    const br_4_75_12_5 = {
      mm: [25,19,12.5,9.5,6.3,4.8,2.4,1.2,0.6,0.3,0.15,0],
      utilizavelLower: [0,0,0,2,40,80,95,100,100,100,100,100],
      utilizavelUpper: [0,0,0,15,65,95,100,100,100,100,100,100],
      otimaLower:    [0,0,0,5,50,90,98,100,100,100,100,100],
      otimaUpper:    [0,0,5,40,85,98,100,100,100,100,100,100]
    };
    const br_9_5_25 = {
      mm: [25,19,12.5,9.5,6.3,4.8,2.4,1.2,0.6,0.3,0.15,0],
      utilizavelLower: [5,2,15,80,92,95,100,100,100,100,100,100],
      utilizavelUpper: [25,15,65,100,100,100,100,100,100,100,100,100],
      otimaLower: [5,2,40,65,92,95,100,100,100,100,100,100],
      otimaUpper: [15,10,80,100,100,100,100,100,100,100,100,100]
    };
    const br_19_31_5 = {
      mm: [25,19,12.5,9.5,6.3,4.8,2.4,1.2,0.6,0.3,0.15,0],
      utilizavelLower: [5,65,92,95,100,100,100,100,100,100,100,100],
      utilizavelUpper: [25,95,100,100,100,100,100,100,100,100,100,100],
      otimaLower: [2,65,92,95,100,100,100,100,100,100,100,100],
      otimaUpper: [15,95,100,100,100,100,100,100,100,100,100,100]
    };
    return {
      sand,
      coarse: {
        "4.75/12.5": br_4_75_12_5,
        "9.5/25": br_9_5_25,
        "19/31.5": br_19_31_5
      }
    };
  }

  function openChartModal(){ chartModalBackdrop.style.display = "flex"; }
  function closeChartModal(){ chartModalBackdrop.style.display = "none"; }
  chartModalCloseBtn?.addEventListener("click", closeChartModal);
  chartModalBackdrop?.addEventListener("click",(e)=>{ if(e.target===chartModalBackdrop) closeChartModal(); });

  /* Utility: draw NBR band polygons on a given SVG using same x/y mapping */
  function drawNbrBand(svgEl, rows, bandMmArray, lowerArr, upperArr, toX, toY, color, opacity=0.18, stroke="none"){
    if(!bandMmArray || !bandMmArray.length) return;
    const indices = bandMmArray.map(mm => rows.findIndex(r => Number(r.mm) === Number(mm)));
    const has = indices.every(ix => ix >= 0);
    if(!has) return;
    const upperPoints = indices.map((ix, i)=>`${toX(ix)},${toY(upperArr[i])}`).join(" ");
    const lowerPointsRev = indices.slice().reverse().map((ix,i)=>`${toX(ix)},${toY(lowerArr[lowerArr.length-1 - i])}`).join(" ");
    const points = `${upperPoints} ${lowerPointsRev}`;
    svgEl.innerHTML += `<polygon points="${points}" fill="${color}" opacity="${opacity}" stroke="${stroke}"></polygon>`;
  }

  function buildGranChart(rows){
    const width = 600;
    const height = 320;
    const pad = 40;

    if(!rows || !rows.length){
      granChartSvg.innerHTML = `<text x="${pad}" y="${pad}" font-size="12">Sem dados para gráfico.</text>`;
      return;
    }

    const xStep = (width - pad*2) / (rows.length - 1);
    const toX = (i) => pad + i * xStep;
    const toY = (val) => pad + ((100 - val) / 100) * (height - pad*2);

    let grid = "";
    for(let v=0; v<=100; v+=20){
      const y = toY(v);
      grid += `<line x1="${pad}" y1="${y}" x2="${width-pad}" y2="${y}" stroke="#d6e3f3" stroke-width="1"/>`;
      grid += `<text x="${pad-8}" y="${y+4}" font-size="10" text-anchor="end" fill="#445">${v}</text>`;
    }

    let xLabels = "";
    rows.forEach((r,i)=>{
      const x = toX(i);
      const label = r.mm === 0 ? "FUNDO" : String(r.mm).replace(".", ",");
      xLabels += `<text x="${x}" y="${height-8}" font-size="10" text-anchor="middle" fill="#445">${label}</text>`;
    });

    const lineRetido = rows.map((r,i)=>`${toX(i)},${toY(r.perc)}`).join(" ");
    const lineAcum = rows.map((r,i)=>`${toX(i)},${toY(r.acum)}`).join(" ");

    const pointsRetido = rows.map((r,i)=>`<circle cx="${toX(i)}" cy="${toY(r.perc)}" r="2.4" fill="#0a6ed1"/>`).join("");
    const pointsAcum = rows.map((r,i)=>`<circle cx="${toX(i)}" cy="${toY(r.acum)}" r="2.4" fill="#e07b00"/>`).join("");

    granChartSvg.innerHTML = `
      <rect x="0" y="0" width="${width}" height="${height}" fill="#fff"/>
      ${grid}
      <line x1="${pad}" y1="${height-pad}" x2="${width-pad}" y2="${height-pad}" stroke="#8aa6c7"/>
      <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${height-pad}" stroke="#8aa6c7"/>
      ${xLabels}
    `;

    const limits = getNbr7211Limits();
    const maxMm = Math.max(...rows.map(r => Number(r.mm)));
    if(maxMm < 12.5){
      const sand = limits.sand;
      const utilizavelLowerAcc = sand.utilizavelLower.map(p=>100 - p);
      const utilizavelUpperAcc = sand.utilizavelUpper.map(p=>100 - p);
      const otimaLowerAcc = sand.otimaLower.map(p=>100 - p);
      const otimaUpperAcc = sand.otimaUpper.map(p=>100 - p);
      drawNbrBand(granChartSvg, rows, sand.mm, utilizavelLowerAcc, utilizavelUpperAcc, toX, toY, "#777777", 0.12);
      drawNbrBand(granChartSvg, rows, sand.mm, otimaLowerAcc, otimaUpperAcc, toX, toY, "#f6c541", 0.16);
    } else {
      const coarse = limits.coarse;
      Object.keys(coarse).forEach(key=>{
        const b = coarse[key];
        const uLower = b.utilizavelLower.map(p=>100 - p);
        const uUpper = b.utilizavelUpper.map(p=>100 - p);
        const oLower = b.otimaLower.map(p=>100 - p);
        const oUpper = b.otimaUpper.map(p=>100 - p);
        drawNbrBand(granChartSvg, rows, b.mm, uLower, uUpper, toX, toY, "#777777", 0.10);
        drawNbrBand(granChartSvg, rows, b.mm, oLower, oUpper, toX, toY, "#f6c541", 0.12);
      });
    }

    granChartSvg.innerHTML += `
      <polyline points="${lineRetido}" fill="none" stroke="#0a6ed1" stroke-width="2"/>
      <polyline points="${lineAcum}" fill="none" stroke="#e07b00" stroke-width="2"/>
      ${pointsRetido}
      ${pointsAcum}
      <text x="${width/2}" y="${height-2}" font-size="10" text-anchor="middle" fill="#445">Abertura da peneira (mm)</text>
      <text x="12" y="${height/2}" font-size="10" text-anchor="middle" fill="#445" transform="rotate(-90 12 ${height/2})">% Retido</text>
    `;
  }

  /* ====== MIX GRAN, TRACO CALC etc (kept) ====== */
  const tracoMixChartSvg = document.getElementById("tracoMixChartSvg");
  const mixChartTitle = document.getElementById("mixChartTitle");

  function computeMixGranFromLastTraco(lastTraco){
    if(!lastTraco || !lastTraco.materials || !lastTraco.traco1m3) return null;
    const EXCLUDE_KEYS = new Set(["agua","aditivo1","aditivo2"]);
    const materialMasses = lastTraco.materials.map(m => {
      const key = m.key;
      const mass = Number(lastTraco.traco1m3?.[key] ?? 0);
      return { key, label: m.label, mass, insumo: m.insumo || null };
    }).filter(m => !EXCLUDE_KEYS.has(m.key) && (m.mass > 0));
    const totalDry = materialMasses.reduce((s,mi)=>s + mi.mass, 0);
    if(!(totalDry > 0)) return null;
    const materialsSieveMaps = materialMasses.map(mi => {
      const ins = mi.insumo;
      const rows = ins?.caracteristicas?.granulometria?.rows || [];
      const map = new Map();
      for(const r of rows){
        map.set(Number(r.mm), Number(r.perc));
      }
      const fundoPerc = ins?.caracteristicas?.granulometria?.fundo?.perc ?? 0;
      map.set(0, Number(fundoPerc));
      return { key: mi.key, mass: mi.mass, map, insumo: mi.insumo };
    });
    const rows = [];
    for(const mm of SIEVES_MM){
      let sumPerc = 0;
      for(const mat of materialsSieveMaps){
        const matPerc = mat.map.get(mm) ?? 0;
        sumPerc += (mat.mass / totalDry) * matPerc;
      }
      rows.push({ mm, perc: sumPerc });
    }
    let fundoSum = 0;
    for(const mat of materialsSieveMaps){
      const f = mat.map.get(0) ?? 0;
      fundoSum += (mat.mass / totalDry) * f;
    }
    rows.push({ mm: 0, perc: fundoSum });
    let cumulative = 0;
    const finalRows = rows.map(r => {
      cumulative += r.perc;
      const pass = Math.max(0, 100 - cumulative);
      return { mm: r.mm, perc: r.perc, acum: cumulative, pass };
    });
    const last = finalRows[finalRows.length-1];
    if(last){
      const diff = 100 - last.acum;
      if(Math.abs(diff) > 1e-6 && finalRows.length){
        const sumPercs = finalRows.reduce((s,r)=>s + (r.perc), 0);
        if(sumPercs > 0){
          finalRows.forEach(r => r.perc = r.perc + (r.perc / sumPercs) * diff);
          let acc = 0;
          finalRows.forEach(r => { acc += r.perc; r.acum = acc; r.pass = Math.max(0, 100 - acc); });
        }
      }
    }
    return { totalDry, rows: finalRows };
  }

  function buildMixGranChart(rows){
    const svgEl = document.getElementById("tracoMixChartSvg");
    const width = 600;
    const height = 320;
    const pad = 40;
    if(!rows || !rows.length){
      svgEl.innerHTML = `<text x="${pad}" y="${pad}" font-size="12">Sem dados para gráfico do traço seco.</text>`;
      return;
    }
    const xStep = (width - pad*2) / (rows.length - 1);
    const toX = (i) => pad + i * xStep;
    const toY = (val) => pad + ((100 - val) / 100) * (height - pad*2);

    let grid = "";
    for(let v=0; v<=100; v+=20){
      const y = toY(v);
      grid += `<line x1="${pad}" y1="${y}" x2="${width-pad}" y2="${y}" stroke="#f0f3fb" stroke-width="1"/>`;
      grid += `<text x="${pad-8}" y="${y+4}" font-size="10" text-anchor="end" fill="#445">${v}</text>`;
    }

    let xLabels = "";
    rows.forEach((r,i)=>{
      const x = toX(i);
      const label = r.mm === 0 ? "FUNDO" : String(r.mm).replace(".", ",");
      xLabels += `<text x="${x}" y="${height-8}" font-size="10" text-anchor="middle" fill="#445">${label}</text>`;
    });

    const lineRetido = rows.map((r,i)=>`${toX(i)},${toY(r.perc)}`).join(" ");
    const lineAcum = rows.map((r,i)=>`${toX(i)},${toY(r.acum)}`).join(" ");

    const pointsRetido = rows.map((r,i)=>`<circle cx="${toX(i)}" cy="${toY(r.perc)}" r="2.6" fill="#0a6ed1"/>`).join("");
    const pointsAcum = rows.map((r,i)=>`<circle cx="${toX(i)}" cy="${toY(r.acum)}" r="2.6" fill="#e07b00"/>`).join("");

    svgEl.innerHTML = `
      <rect x="0" y="0" width="${width}" height="${height}" fill="#fff"/>
      ${grid}
      <line x1="${pad}" y1="${height-pad}" x2="${width-pad}" y2="${height-pad}" stroke="#8aa6c7"/>
      <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${height-pad}" stroke="#8aa6c7"/>
      ${xLabels}
      <polyline points="${lineRetido}" fill="none" stroke="#0a6ed1" stroke-width="2"/>
      <polyline points="${lineAcum}" fill="none" stroke="#e07b00" stroke-width="2"/>
      ${pointsRetido}
      ${pointsAcum}
      <text x="${width/2}" y="${height-2}" font-size="10" text-anchor="middle" fill="#445">Abertura da peneira (mm)</text>
      <text x="12" y="${height/2}" font-size="10" text-anchor="middle" fill="#445" transform="rotate(-90 12 ${height/2})">% Retido (traço seco)</text>
    `;
  }

  function computeAndRenderMixGran(){
    const last = state.lastTraco;
    const svgEl = document.getElementById("tracoMixChartSvg");
    const titleEl = document.getElementById("mixChartTitle");
    if(!last){
      if(svgEl) svgEl.innerHTML = `<text x="20" y="20" font-size="12">Calcule o traço para visualizar a curva do traço seco.</text>`;
      if(titleEl) titleEl.textContent = "—";
      return;
    }
    const mix = computeMixGranFromLastTraco(last);
    if(!mix || !mix.rows || !mix.rows.length){
      if(svgEl) svgEl.innerHTML = `<text x="20" y="20" font-size="12">Não foi possível gerar a curva (massa seca = 0 ou falta de dados de granulometria).</text>`;
      if(titleEl) titleEl.textContent = `Curva do traço — ${last.clienteNome || "(cliente)"}`;
      return;
    }
    buildMixGranChart(mix.rows);
    if(titleEl) titleEl.textContent = `Curva do traço — ${last.clienteNome || "(cliente)"}`;
  }

  function openGranChartForInsumo(insumo){
    const rows = insumo?.caracteristicas?.granulometria?.rows || [];
    if(!rows.length){
      alert("Este insumo ainda não possui granulometria cadastrada.");
      return;
    }
    chartModalSub.textContent = `Insumo: ${insumo.insumo} • Tipo: ${insumo.tipo} • Fornecedor: ${insumo.fornecedor}`;
    chartTitle.textContent = "Curva granulométrica";
    buildGranChart(rows);
    openChartModal();
  }

  /* ========= granulometry and MF calculation (NBR 7211 compliant) ========= */
  function computeGranulometry(masses){
    let total=0; for(const mm of SIEVES_MM) total+=numOr0(masses[String(mm)]); total+=numOr0(masses["fundo"]);
    const rows=[]; let acum=0;
    for(const mm of SIEVES_MM){
      const m=numOr0(masses[String(mm)]);
      const perc= total>0 ? (m/total)*100 : 0;
      acum+=perc; const pass=Math.max(0,100-acum);
      rows.push({mm,massa:m,perc,acum,pass});
    }
    const fundoM=numOr0(masses["fundo"]);
    const fundoPerc= total>0 ? (fundoM/total)*100 : 0;
    const fundoAcum=acum+fundoPerc;
    const fundoPass=Math.max(0,100-fundoAcum);
    const mapAcum=new Map(rows.map(r=>[r.mm,r.acum]));
    let somaAcumMF=0; for(const mm of MF_SIEVES) somaAcumMF+=(mapAcum.get(mm)??0);
    const mf=somaAcumMF/100;
    return { total, rows, fundo:{massa:fundoM, perc:fundoPerc, acum:fundoAcum, pass:fundoPass}, mf };
  }

  function updateComputedOnly(){
    const { total, rows, fundo, mf }=computeGranulometry(modalGranMasses);
    totalMassaRetidaInput.value= total ? fmtPt(total,2) : "0,00";
    mfCalculadoInput.value= total ? fmtPt(mf,2) : "0,00";
    const rowEls=granTbody.querySelectorAll("tr");
    rows.forEach((r,idx)=>{
      const tr=rowEls[idx]; if(!tr) return;
      tr.querySelector('[data-col="perc"]').textContent=`${fmtPt(r.perc,1)}%`;
      tr.querySelector('[data-col="acum"]').textContent=`${fmtPt(r.acum,1)}%`;
      tr.querySelector('[data-col="pass"]').textContent=`${fmtPt(r.pass,1)}%`;
    });
    fundoPercEl.textContent=`${fmtPt(fundo.perc,1)}%`;
    fundoAcumEl.textContent=`${fmtPt(fundo.acum,1)}%`;
    fundoPassEl.textContent=`${fmtPt(fundo.pass,1)}%`;
  }
  function commitValueFromInput(inputEl){ const key=inputEl.getAttribute("data-sieve"); modalGranMasses[String(key)]=inputEl.value; updateComputedOnly(); }
  function focusNextGranInput(currentEl){ const all=Array.from(carModalBackdrop.querySelectorAll("input.gran-massa")); const idx=all.indexOf(currentEl); if(idx>=0 && idx<all.length-1){ all[idx+1].focus(); all[idx+1].select?.(); } }
  function renderGranTableInitial(){
    granTbody.innerHTML="";
    for(const mm of SIEVES_MM){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td class="nowrap">${String(mm).replace(".", ",")}</td>
        <td class="right"><input data-sieve="${mm}" class="gran-massa gran-input" inputmode="decimal" value="${(modalGranMasses[String(mm)] ?? "")}" placeholder="0" /></td>
        <td class="right" data-col="perc">0,0%</td>
        <td class="right" data-col="acum">0,0%</td>
        <td class="right" data-col="pass">0,0%</td>
      `;
      granTbody.appendChild(tr);
    }
    fundoMassaEl.innerHTML=`<input data-sieve="fundo" class="gran-massa gran-input" inputmode="decimal" value="${(modalGranMasses["fundo"] ?? "")}" placeholder="0" />`;
    carModalBackdrop.querySelectorAll("input.gran-massa").forEach(inp=>{
      inp.addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); commitValueFromInput(inp); focusNextGranInput(inp);} });
      inp.addEventListener("blur", ()=>commitValueFromInput(inp));
    });
    updateComputedOnly();
  }
  function openCaracteristicasModal(){
    const c=getSelectedCliente(); const ins=getSelectedInsumo(); if(!(c&&ins)) return;
    carModalSub.textContent=`Cliente: ${c.empresa} • Insumo: ${ins.insumo} (${ins.tipo}) • Fornecedor: ${ins.fornecedor}`;
    carEditStatus.textContent=ins.insumo;
    const car=ins.caracteristicas||{};
    massaEspecificaInput.value=(car.massaEspecifica ?? "");
    if(valorKgModal) valorKgModal.value = (ins.valorKg ?? "");
    modalGranMasses={}; const saved=car.granulometria?.masses||{};
    for(const mm of SIEVES_MM) modalGranMasses[String(mm)]=(saved[String(mm)] ?? "");
    modalGranMasses["fundo"]=(saved["fundo"] ?? "");
    renderGranTableInitial();
    carModalBackdrop.style.display="flex";
  }
  function closeCaracteristicasModal(){ carModalBackdrop.style.display="none"; }

  function formatMassaEspecificaDisplay(val){ const n=Number(val); return Number.isFinite(n)? n.toLocaleString("pt-BR",{minimumFractionDigits:3, maximumFractionDigits:3}) : "—"; }
  function formatMFDisplay(val){ const n=Number(val); return Number.isFinite(n)? n.toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2}) : "—"; }

  const trClienteSel=$("#trCliente");
  const trMaterialSelects=[ $("#matCimento"), $("#matAdicao"), $("#matAgua"), $("#matAreia1"), $("#matAreia2"), $("#matAreia3"), $("#matBrita0"), $("#matBrita12"), $("#matBrita1"), $("#matAditivo1"), $("#matAditivo2") ];

  function setOptions(selectEl, options, keepValue=true){
    const prev=selectEl.value; selectEl.innerHTML="";
    for(const opt of options){ const o=document.createElement("option"); o.value=opt.value; o.textContent=opt.label; selectEl.appendChild(o); }
    if(keepValue && options.some(o=>o.value===prev)) selectEl.value=prev; else selectEl.value="";
  }
  function syncTracoClientesSelect(forceSelectTopCliente){
    const opts=[{value:"",label:"(selecionar...)"}, ...state.clientes.map(c=>({value:c.id,label:c.empresa}))];
    const prev=trClienteSel.value;
    setOptions(trClienteSel, opts, true);
    if(forceSelectTopCliente && !trClienteSel.value && state.selectedClienteId) trClienteSel.value=state.selectedClienteId;
    if(prev && !opts.some(o=>o.value===prev)) trClienteSel.value=state.selectedClienteId || "";
  }
  function getInsumosOptionsForCliente(clienteId){
    const c=state.clientes.find(x=>x.id===clienteId)||null;
    const base=[{value:"",label:"(selecionar...)"}];
    if(!c) return base;
    const insumos=Array.isArray(c.insumos)?c.insumos:[];
    return base.concat(insumos.map(i=>({value:i.id,label:`${i.insumo} • ${i.tipo} • ${i.fornecedor}`})));
  }
  function syncTracoMaterialSelects(clearSelections){
    const options=getInsumosOptionsForCliente(trClienteSel.value||"");
    trMaterialSelects.forEach(sel=>setOptions(sel, options, !clearSelections));
  }
  function syncTracoUI(forceSelectTopCliente=false){
    syncTracoClientesSelect(forceSelectTopCliente);
    syncTracoMaterialSelects(false);
  }
  trClienteSel.addEventListener("change", ()=>{ syncTracoMaterialSelects(true); });

  const trVolumeInput = trVolume;
  function handleVolumeDesejadoChange(){
    const v = numOr0(trVolumeInput.value);
    state.printForm.volumeM3 = v > 0 ? v : "";
    saveState();
    renderPrintPanel();
  }
  trVolumeInput.addEventListener("input", handleVolumeDesejadoChange);
  trVolumeInput.addEventListener("change", handleVolumeDesejadoChange);

  const inArgamassa=$("#inArgamassa");
  const inAC=$("#inAC");
  const inAr=$("#inAr");
  const inH=$("#inH");
  const inAdicaoPct=$("#inAdicaoPct");
  const inAditivo1Pct=$("#inAditivo1Pct");
  const inAditivo2Pct=$("#inAditivo2Pct");

  const matCimento=$("#matCimento");
  const matAdicao=$("#matAdicao");
  const matAgua=$("#matAgua");
  const matAreia1=$("#matAreia1");
  const matAreia2=$("#matAreia2");
  const matAreia3=$("#matAreia3");
  const matBrita0=$("#matBrita0");
  const matBrita12=$("#matBrita12");
  const matBrita1=$("#matBrita1");
  const matAditivo1=$("#matAditivo1");
  const matAditivo2=$("#matAditivo2");

  const pctAreia1=$("#pctAreia1");
  const pctAreia2=$("#pctAreia2");
  const pctAreia3=$("#pctAreia3");
  const pctBrita0=$("#pctBrita0");
  const pctBrita12=$("#pctBrita12");
  const pctBrita1=$("#pctBrita1");
  const areiasSumHint=$("#areiasSumHint");
  const britasSumHint=$("#britasSumHint");

  const calcTracoBtn=$("#calcTracoBtn");
  const tracoStatus=$("#tracoStatus");
  const outM=$("#outM");
  const outA=$("#outA");
  const outB=$("#outB");
  const outCc=$("#outCc");
  const tracoTbody=$("#tracoTbody");
  const tracoEmpty=$("#tracoEmpty");

  function updatePctHints(){
    const sAreias=numOr0(pctAreia1.value)+numOr0(pctAreia2.value)+numOr0(pctAreia3.value);
    const sBritas=numOr0(pctBrita0.value)+numOr0(pctBrita12.value)+numOr0(pctBrita1.value);
    areiasSumHint.textContent=`Soma: ${fmtPt(sAreias,1)}%`;
    britasSumHint.textContent=`Soma: ${fmtPt(sBritas,1)}%`;
    areiasSumHint.style.color=Math.abs(sAreias-100)<0.0001?"var(--muted)":"var(--danger)";
    britasSumHint.style.color=Math.abs(sBritas-100)<0.0001?"var(--muted)":"var(--danger)";
  }
  [pctAreia1,pctAreia2,pctAreia3,pctBrita0,pctBrita12,pctBrita1].forEach(el=>el.addEventListener("input",updatePctHints));

  function findInsumoById(cliente,id){ if(!cliente||!id) return null; return (cliente.insumos||[]).find(i=>i.id===id)||null; }
  function getMEandMF(insumo){ const me=insumo?.caracteristicas?.massaEspecifica ?? null; const mf=insumo?.caracteristicas?.mf ?? null; return {me,mf}; }
  function getDensity(insumo){ const me=insumo?.caracteristicas?.massaEspecifica; const n=Number(me); return Number.isFinite(n)?n:0; }

  function calcTraco(){
    const cliente=state.clientes.find(c=>c.id===(trClienteSel.value||""))||null;
    if(!cliente){ alert("Selecione um cliente no Traço."); return; }
    const sumAreias=numOr0(pctAreia1.value)+numOr0(pctAreia2.value)+numOr0(pctAreia3.value);
    const sumBritas=numOr0(pctBrita0.value)+numOr0(pctBrita12.value)+numOr0(pctBrita1.value);
    if(Math.abs(sumAreias-100)>0.0001){ alert("A soma das areias deve ser 100%."); return; }
    if(Math.abs(sumBritas-100)>0.0001){ alert("A soma das britas deve ser 100%."); return; }
    const argamassa=numOr0(inArgamassa.value)/100;
    const ac=numOr0(inAC.value);
    const ar=numOr0(inAr.value)/100;
    const h=numOr0(inH.value)/100;
    const adicaoFrac=numOr0(inAdicaoPct.value)/100;
    const adit1=numOr0(inAditivo1Pct.value)/100;
    const adit2=numOr0(inAditivo2Pct.value)/100;
    if(!(h>0)){ alert("H deve ser > 0."); return; }

    const pA1=numOr0(pctAreia1.value)/100, pA2=numOr0(pctAreia2.value)/100, pA3=numOr0(pctAreia3.value)/100;
    const pB0=numOr0(pctBrita0.value)/100, pB12=numOr0(pctBrita12.value)/100, pB1=numOr0(pctBrita1.value)/100;

    const m=(ac/h) - (1 + adicaoFrac);
    const a=(argamassa * ((1 + adicaoFrac) + m)) - (1 + adicaoFrac);
    const b=m - a;

    const unit={
      cimento:1,
      adicao:adicaoFrac,
      areia1:a*pA1,
      areia2:a*pA2,
      areia3:a*pA3,
      brita0:b*pB0,
      brita12:b*pB12,
      brita1:b*pB1,
      agua:ac,
      aditivo1:adit1,
      aditivo2:adit2
    };

    const sel={
      cimento: findInsumoById(cliente, matCimento.value),
      adicao: findInsumoById(cliente, matAdicao.value),
      areia1: findInsumoById(cliente, matAreia1.value),
      areia2: findInsumoById(cliente, matAreia2.value),
      areia3: findInsumoById(cliente, matAreia3.value),
      brita0: findInsumoById(cliente, matBrita0.value),
      brita12: findInsumoById(cliente, matBrita12.value),
      brita1: findInsumoById(cliente, matBrita1.value),
      agua: findInsumoById(cliente, matAgua.value),
      aditivo1: findInsumoById(cliente, matAditivo1.value),
      aditivo2: findInsumoById(cliente, matAditivo2.value),
    };

    let soma=0; for(const key of Object.keys(unit)){ const Bi=getDensity(sel[key]); const Di=unit[key]; if(Di>0 && Bi>0) soma+=Di/Bi; }
    if(!(soma>0)){ alert("Para calcular Cc: selecione materiais com M.E cadastrada."); return; }
    const Cc=(1000*(1-ar))/soma;

    const volume=Math.max(0, numOr0(trVolume.value)||1);
    const traco1m3=Object.fromEntries(Object.entries(unit).map(([k,v])=>[k, Cc*v]));
    const tracoVol=Object.fromEntries(Object.entries(traco1m3).map(([k,v])=>[k, v*volume]));

    outM.value=fmtPt(m,4);
    outA.value=fmtPt(a,4);
    outB.value=fmtPt(b,4);
    outCc.value=fmtPt(Cc,1);

    const rows=[
      ["Cimento","cimento"],
      ["Adição","adicao"],
      ["Areia 1","areia1"],
      ["Areia 2","areia2"],
      ["Areia 3","areia3"],
      ["Brita 0","brita0"],
      ["Brita 1/2","brita12"],
      ["Brita 1","brita1"],
      ["Água","agua"],
      ["Aditivo 1","aditivo1"],
      ["Aditivo 2","aditivo2"],
    ];

    tracoTbody.innerHTML="";
    for(const [label,key] of rows){
      const {me,mf}=getMEandMF(sel[key]);
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${label}${sel[key]?`<br/><span style="color:var(--muted); font-size:11px;">${escapeHtml(sel[key].insumo)}</span>`:`<br/><span style="color:var(--muted); font-size:11px;">(não selecionado)</span>`}</td>
        <td class="nowrap">${me?Number(me).toLocaleString("pt-BR",{minimumFractionDigits:3, maximumFractionDigits:3}):"—"}</td>
        <td class="nowrap">${(mf!==null&&mf!==undefined&&mf!=="")?Number(mf).toLocaleString("pt-BR",{minimumFractionDigits:2, maximumFractionDigits:2}):"—"}</td>
        <td class="right nowrap">${fmtPt(unit[key],4)}</td>
        <td class="right nowrap">${fmtPt(traco1m3[key],1)}</td>
        <td class="right nowrap">${fmtPt(tracoVol[key],1)}</td>
      `;
      tracoTbody.appendChild(tr);
    }

    tracoEmpty.style.display="none";
    tracoStatus.textContent=`Cc=${fmtPt(Cc,1)} kg/m³ • Volume=${fmtPt(volume,2)} m³`;

    state.lastTraco={
      id: state.lastTraco?.id || uid(),
      volume,
      clienteId: cliente?.id || null,
      clienteNome: cliente?.empresa || "(sem cliente)",
      inputs:{
        argamassa:numOr0(inArgamassa.value),
        ac:numOr0(inAC.value),
        ar:numOr0(inAr.value),
        h:numOr0(inH.value),
        adicaoPct:numOr0(inAdicaoPct.value),
        aditivo1Pct:numOr0(inAditivo1Pct.value),
        aditivo2Pct:numOr0(inAditivo2Pct.value),
        pctAreia1:numOr0(pctAreia1.value),
        pctAreia2:numOr0(pctAreia2.value),
        pctAreia3:numOr0(pctAreia3.value),
        pctBrita0:numOr0(pctBrita0.value),
        pctBrita12:numOr0(pctBrita12.value),
        pctBrita1:numOr0(pctBrita1.value)
      },
      materials: rows.map(([label,key])=>({label,key,insumo: sel[key]||null})),
      traco1m3,
      tracoVol,
      titulo: trTitulo.value || "",
      dataEstudo: trData.value || "",
      m, a, b, Cc
    };
    state.printForm.volumeM3 = volume;

    saveState();
    renderPrintPanel();
    computeAndRenderMixGran();
  }
  calcTracoBtn.addEventListener("click", calcTraco);

  /* ========= snapshot atualizado para o histórico ========= */
  function buildSnapshotForHistory(){
    const last = state.lastTraco;
    if(!last){ alert("Calcule o traço antes de salvar."); return null; }

    const baseDate = state.printForm?.data || last.dataEstudo || "";
    const numeroTraco = state.printForm?.numeroTraco || `T-${Date.now()}`;
    const clienteNome = last.clienteNome || "(sem cliente)";

    // Insumos: incluir fornecedor, tipo e display amigável
    const insumos = (last.materials || []).map(m => {
      const ins = m.insumo || null;
      return {
        material: m.label || m.key,
        key: m.key,
        insumo: ins?.insumo || "-",
        tipo: ins?.tipo || "",
        fornecedor: ins?.fornecedor || "",
        display: ins ? `${ins.insumo} (${ins.fornecedor || "-"})` : "-"
      };
    });

    // Quantidades: use traco1m3 (kg / 1 m³)
    const quantidades = (last.materials || []).map(m => {
      const perM3 = Number(last.traco1m3?.[m.key] ?? 0);
      const dosagem = perM3; // kg por 1 m³
      const umidade = 0; // initially empty
      const corrigido = dosagem;
      return {
        key: m.key,
        dosagem: dosagem,
        umidade: umidade,
        corrigido: corrigido,
        display: dosagem ? `${fmtPt(dosagem,1)} kg` : "-"
      };
    });

    // Resultados placeholders
    const resultados = (state.printForm?.resistencias || RUPTURA_DIAS.map(d=>({ idade:`${d} dias` }))).map(r => {
      return { idade: r.idade || "", data: "", comp: "", tracao: "", evol: "", display: "" };
    });

    // form snapshot
    const formSnapshot = Object.assign({}, state.printForm || {});
    formSnapshot.data = formSnapshot.data || baseDate || "";
    formSnapshot.volumeM3 = formSnapshot.volumeM3 ?? last.volume ?? 1;
    formSnapshot.titulo = state.lastTraco?.titulo || "";

    return {
      id: uid(),
      numeroTraco,
      clienteNome,
      dataEstudo: last.dataEstudo || "",
      createdAt: new Date().toISOString(),
      form: formSnapshot,
      insumos,
      quantidades,
      resultados
    };
  }

  /* ========= salvarTraco atualizado: também insere no histórico automaticamente ========= */
  function salvarTraco(){
    const cliente = state.clientes.find(c=>c.id===trClienteSel.value) || null;
    if(!cliente){ alert("Selecione um cliente."); return; }
    if(!state.lastTraco){ alert("Calcule o traço antes de salvar."); return; }
    const titulo = trTitulo.value.trim();
    const dataEstudo = trData.value || "";
    if(!titulo){ alert("Informe um título do estudo."); return; }
    if(!dataEstudo){ alert("Informe a data do estudo."); return; }
    if(!confirm("Deseja salvar/inserir este traço?")) return;

    const id = state.selectedTracoId || uid();
    const snapshot = {
      id,
      clienteId: cliente.id,
      clienteNome: cliente.empresa,
      titulo,
      dataEstudo,
      volume: Math.max(0, numOr0(trVolume.value)||1),
      inputs: state.lastTraco.inputs,
      materials: state.lastTraco.materials,
      traco1m3: state.lastTraco.traco1m3,
      tracoVol: state.lastTraco.tracoVol,
      resumoInsumos: summarizeInsumos(state.lastTraco.materials || [])
    };

    const existingIdx = state.tracosSalvos.findIndex(t=>t.id===id);
    if(existingIdx>=0) state.tracosSalvos[existingIdx]=snapshot;
    else state.tracosSalvos.unshift(snapshot);

    state.lastTraco = snapshot;
    state.selectedTracoId = id;

    // insert snapshot into history
    try{
      const histSnap = buildSnapshotForHistory();
      if(histSnap){
        const duplicate = state.tracosHistorico.some(h => h.numeroTraco === histSnap.numeroTraco && h.clienteNome === histSnap.clienteNome && h.dataEstudo === histSnap.dataEstudo);
        if(!duplicate){
          state.tracosHistorico.unshift(histSnap);
        }
      }
    }catch(e){
      console.error("Erro ao criar snapshot histórico automático:", e);
    }

    saveState();
    renderTracosSalvos();
    renderPrintPanel();
    computeAndRenderMixGran();
    renderHistorico();
    renderCorrigidoInit(); // update corrigido options
    alert("Traço salvo e sincronizado com a impressão e histórico.");
  }
  salvarTracoBtn.addEventListener("click", salvarTraco);

  /* ========= helper: summarize insumos for snapshot =========== */
  function summarizeInsumos(materials){
    return (materials||[]).map(m=>m.label+(m.insumo?` (${m.insumo.insumo})`:"")).join(", ");
  }

  /* ========= EXPORTAÇÃO CSV ========= */
  function buildCSV(rows){
    const escapeCell = (v) => {
      const s = String(v ?? "");
      if(s.includes('"') || s.includes(";") || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
      return s;
    };
    return rows.map(row => row.map(escapeCell).join(";")).join("\n");
  }

  function downloadCSV(filename, rows){
    const csv = buildCSV(rows);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportClientesInsumosCSV(){
    const rows = [[
      "Cliente ID","Empresa","Segmento","Endereço","Telefone","E-mail",
      "Insumo","Tipo","Fornecedor","Massa Específica","MF"
    ]];

    (state.clientes || []).forEach(c=>{
      const insumos = Array.isArray(c.insumos) && c.insumos.length ? c.insumos : [null];
      insumos.forEach(ins=>{
        rows.push([
          c.id || "",
          c.empresa || "",
          c.segmento || "",
          c.endereco || "",
          c.telefone || "",
          c.email || "",
          ins?.insumo || "",
          ins?.tipo || "",
          ins?.fornecedor || "",
          ins?.caracteristicas?.massaEspecifica ?? "",
          ins?.caracteristicas?.mf ?? ""
        ]);
      });
    });

    downloadCSV("clientes_insumos.csv", rows);
  }

  function exportHistoricoInsumosCSV(){
    const rows = [[
      "Nº traço","Cliente","Cimento","Adição","Areia 1","Areia 2","Areia 3",
      "Brita 0","Brita 1/2","Brita 1","Água","Aditivo 1","Aditivo 2"
    ]];
    (state.tracosHistorico||[]).forEach(t=>{
      const ins = t.insumos || [];
      const pick = (key)=> (ins.find(x=>x.key===key)?.display || ins.find(x=>x.key===key)?.insumo || "-");
      rows.push([
        t.numeroTraco || "",
        t.clienteNome || "",
        pick("cimento"), pick("adicao"), pick("areia1"), pick("areia2"), pick("areia3"),
        pick("brita0"), pick("brita12"), pick("brita1"), pick("agua"), pick("aditivo1"), pick("aditivo2")
      ]);
    });
    downloadCSV("historico_insumos.csv", rows);
  }

  function exportHistoricoQuantCSV(){
    const rows = [[
      "Nº traço","Cliente","Cimento","Adição","Areia 1","Areia 2","Areia 3",
      "Brita 0","Brita 1/2","Brita 1","Água","Aditivo 1","Aditivo 2"
    ]];
    (state.tracosHistorico||[]).forEach(t=>{
      const qs = t.quantidades || [];
      const pick = (key)=> (qs.find(x=>x.key===key)?.display || "");
      rows.push([
        t.numeroTraco || "",
        t.clienteNome || "",
        pick("cimento"), pick("adicao"), pick("areia1"), pick("areia2"), pick("areia3"),
        pick("brita0"), pick("brita12"), pick("brita1"), pick("agua"), pick("aditivo1"), pick("aditivo2")
      ]);
    });
    downloadCSV("historico_quantidades.csv", rows);
  }

  function exportHistoricoResultadosCSV(){
    const rows = [[
      "Nº traço","Cliente","Data do estudo","1 dia","3 dias","7 dias","14 dias","28 dias","56 dias","63 dias"
    ]];
    (state.tracosHistorico||[]).forEach(t=>{
      const res = t.resultados || [];
      const pick = (i)=> (res[i]?.display || "");
      rows.push([
        t.numeroTraco || "",
        t.clienteNome || "",
        t.dataEstudo || "",
        pick(0), pick(1), pick(2), pick(3), pick(4), pick(5), pick(6)
      ]);
    });
    downloadCSV("historico_resultados.csv", rows);
  }

  function exportHistoricoFormCSV(){
    const rows = [[
      "Nº traço","Cliente","Data","Slump","Slump 15","Slump corr.","Água add.","Água retida",
      "Temp conc.","Temp amb.","Umid. amb.","Volume (m³)","Volume lab (m³)"
    ]];
    (state.tracosHistorico||[]).forEach(t=>{
      const f = t.form || {};
      rows.push([
        t.numeroTraco || "",
        t.clienteNome || "",
        f.data || "",
        f.slump || "",
        f.slump15 || "",
        f.slumpCorrigido || "",
        f.aguaAdicionada || "",
        f.aguaRetida || "",
        f.tempConc || "",
        f.tempAmb || "",
        f.umidAmb || "",
        f.volumeM3 ?? "",
        f.volumeLab ?? ""
      ]);
    });
    downloadCSV("historico_formulario.csv", rows);
  }

  document.getElementById("exportClientesInsumosBtn")?.addEventListener("click", exportClientesInsumosCSV);
  document.getElementById("exportHistInsumosBtn")?.addEventListener("click", exportHistoricoInsumosCSV);
  document.getElementById("exportHistQuantBtn")?.addEventListener("click", exportHistoricoQuantCSV);
  document.getElementById("exportHistResultadosBtn")?.addEventListener("click", exportHistoricoResultadosCSV);
  document.getElementById("exportHistFormBtn")?.addEventListener("click", exportHistoricoFormCSV);

  function renderTopSelection(){ const c=getSelectedCliente(); const i=getSelectedInsumo(); uiClienteSel.textContent=c?c.empresa:"Nenhum"; uiInsumoSel.textContent=i?i.insumo:"Nenhum"; }
  function getSelectedCliente(){ return state.clientes.find(c => c.id === state.selectedClienteId) || null; }
  function getSelectedInsumo(){ const c=getSelectedCliente(); if(!c) return null; return (c.insumos||[]).find(i=>i.id===state.selectedInsumoId)||null; }

  function renderClientes(){
    clientesTbody.innerHTML=""; clientesEmpty.hidden=state.clientes.length!==0;
    state.clientes.forEach(c=>{
      const tr=document.createElement("tr"); tr.style.cursor="pointer";
      if(c.id===state.selectedClienteId){ tr.style.outline="2px solid rgba(0,0,0,.2)"; tr.style.outlineOffset="-2px"; }
      tr.innerHTML=`
        <td><strong>${escapeHtml(c.empresa)}</strong><br/><span style="color:#555; font-size:11px;">${escapeHtml(c.endereco)}</span></td>
        <td>${escapeHtml(c.segmento)}</td>
        <td>${escapeHtml(c.telefone)}<br/><span style="color:#555; font-size:11px;">${escapeHtml(c.email)}</span></td>
      `;
      tr.addEventListener("click", ()=>{ state.selectedClienteId=c.id; state.selectedInsumoId=null; saveState(); renderAll(); });
      clientesTbody.appendChild(tr);
    });
    const csel=getSelectedCliente();
    removerClienteBtn.disabled=!csel;
    irParaInsumosBtn.disabled=!csel;
  }

  function renderInsumos(){
    const c=getSelectedCliente(); const insumos=c?.insumos || [];
    insumosClienteNome.textContent=c?c.empresa:"Nenhum";
    salvarInsumoBtn.disabled=!c; limparInsumoBtn.disabled=!c;
    insumosTbody.innerHTML=""; insumosEmpty.hidden=insumos.length!==0;
    for(const ins of insumos){
      const tr=document.createElement("tr"); tr.style.cursor="pointer";
      tr.dataset.insumoId = ins.id;
      if(ins.id===state.selectedInsumoId){ tr.style.outline="2px solid rgba(0,0,0,.2)"; tr.style.outlineOffset="-2px"; }
      const me=ins.caracteristicas?.massaEspecifica ?? "";
      const mf=ins.caracteristicas?.mf ?? "";

      const actionsHtml = `
        <div class="icon-actions">
          <button type="button" class="icon-btn" data-action="chart" title="Curva" aria-label="Curva">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 3v18h18"></path>
              <path d="M7 13v-6"></path>
              <path d="M12 13v-10"></path>
              <path d="M17 13v-2"></path>
            </svg>
          </button>
          <button type="button" class="icon-btn icon-edit" data-action="car" title="Características" aria-label="Características">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
            </svg>
          </button>
          <button type="button" class="icon-btn icon-delete" data-action="remover" title="Remover" aria-label="Remover">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
              <path d="M10 11v6"></path>
              <path d="M14 11v6"></path>
            </svg>
          </button>
        </div>
      `;

      tr.innerHTML=`
        <td><strong>${escapeHtml(ins.insumo)}</strong><br/><span style="color:#555; font-size:11px;">${escapeHtml(ins.tipo)} • ${escapeHtml(ins.fornecedor)}</span></td>
        <td class="nowrap">${formatMassaEspecificaDisplay(me)}</td>
        <td class="nowrap">${formatMFDisplay(mf)}</td>
        <td class="nowrap"><input data-field="valorKg" data-insumo-id="${ins.id}" type="number" step="0.01" min="0" value="${ins.valorKg ?? ""}" style="width:100px;text-align:right;" /></td>
        <td class="nowrap">${actionsHtml}</td>
      `;

      tr.addEventListener("click",(e)=>{
        const isButton = e.target.closest("button[data-action]");
        const isInput = e.target.closest("input");
        if(isButton || isInput) return;
        state.selectedInsumoId=ins.id; saveState(); renderAll();
      });

      const costInput = tr.querySelector('input[data-field="valorKg"]');
      if(costInput){
        costInput.addEventListener('change', (e)=>{
          const newVal = numOr0(e.target.value);
          const clienteAtual = c;
          if(clienteAtual && Array.isArray(clienteAtual.insumos)){
            const insRef = clienteAtual.insumos.find(x => x.id === costInput.dataset.insumoId);
            if(insRef){
              insRef.valorKg = newVal;
              saveState();
              renderInsumos();
            }
          }
        });
      }

      (()=>{ // per-row buttons
        const btnChart = tr.querySelector('button[data-action="chart"]');
        if (btnChart) {
          btnChart.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const insData = ins;
            if (!insData) { alert('Insumo não encontrado.'); return; }
            const rows = insData?.caracteristicas?.granulometria?.rows || [];
            if (!rows.length) { alert('Este insumo ainda não possui granulometria cadastrada.'); return; }
            chartModalSub.textContent = `Insumo: ${insData.insumo} • Tipo: ${insData.tipo} • Fornecedor: ${insData.fornecedor}`;
            chartTitle.textContent = "Curva granulométrica";
            buildGranChart(rows);
            openChartModal();
          });
        }

        const btnCar = tr.querySelector('button[data-action="car"]');
        if (btnCar) {
          btnCar.addEventListener('click', (ev) => {
            ev.stopPropagation();
            if(c && c.id) state.selectedClienteId = c.id;
            state.selectedInsumoId = ins.id;
            saveState();
            setActiveTab("caracteristicas");
            renderAll();
            setTimeout(() => {
              openCaracteristicasModal();
            }, 50);
          });
        }

        const btnRem = tr.querySelector('button[data-action="remover"]');
        if (btnRem) {
          btnRem.addEventListener('click', (ev) => {
            ev.stopPropagation();
            if (!confirm('Remover este insumo?')) return;
            if(!c){
              for(const cc of (state.clientes||[])){
                if((cc.insumos||[]).some(x=>x.id===ins.id)){ c = cc; break; }
              }
            }
            if(c){
              c.insumos = (c.insumos||[]).filter(x=>x.id !== ins.id);
            } else {
              state.clientes.forEach(cc => cc.insumos = (cc.insumos||[]).filter(x=>x.id !== ins.id));
            }
            if(state.selectedInsumoId===ins.id) state.selectedInsumoId=null;
            saveState();
            renderAll();
          });
        }
      })();

      insumosTbody.appendChild(tr);
    }
    irParaCaracteristicasBtn.disabled=!getSelectedInsumo();
  }

  function removerInsumo(insumoId){
    let c=getSelectedCliente(); if(!c) {
      for(const cc of (state.clientes||[])){
        if((cc.insumos||[]).some(x=>x.id===insumoId)){ c = cc; break; }
      }
    }
    if(!c) return;
    const ok=confirm("Remover este insumo?"); if(!ok) return;
    c.insumos=(c.insumos||[]).filter(x=>x.id!==insumoId);
    if(state.selectedInsumoId===insumoId) state.selectedInsumoId=null;
    saveState();
    renderAll();
  }
  function renderCaracteristicasPanel(){
    const c=getSelectedCliente(); const i=getSelectedInsumo();
    carClienteNome.textContent=c?c.empresa:"Nenhum";
    carInsumoNome.textContent=i?i.insumo:"Nenhum";
    abrirModalCarBtn.disabled=!(c&&i);
  }

  $("#limparClienteBtn").addEventListener("click", ()=>clienteForm.reset());
  $("#desselecionarClienteBtn").addEventListener("click", ()=>{ state.selectedClienteId=null; state.selectedInsumoId=null; saveState(); renderAll(); });
  $("#removerClienteBtn").addEventListener("click", ()=>{
    const c=getSelectedCliente(); if(!c) return;
    const ok=confirm(`Remover o cliente "${c.empresa}" e todos os insumos?`); if(!ok) return;
    state.clientes=state.clientes.filter(x=>x.id!==c.id);
    state.selectedClienteId=state.clientes[0]?.id ?? null;
    state.selectedInsumoId=null;
    saveState();
    renderAll();
  });
  $("#limparTudoBtn").addEventListener("click", ()=>{
    const ok=confirm("Apagar TODOS os dados salvos?"); if(!ok) return;
    localStorage.removeItem(STORAGE_KEY);
    state=loadState();
    setActiveTab("clientes");
    renderAll();
  });

  $("#irParaInsumosBtn").addEventListener("click", ()=>setActiveTab("insumos"));
  $("#irParaCaracteristicasBtn").addEventListener("click", ()=>setActiveTab("caracteristicas"));

  clienteForm.addEventListener("submit",(e)=>{
    e.preventDefault();
    const empresa=$("#empresa").value.trim();
    const endereco=$("#endereco").value.trim();
    const telefone=$("#telefone").value.trim();
    const email=$("#email").value.trim();
    const segmento=$("#segmento").value;
    if(!empresa||!endereco||!telefone||!email||!segmento) return;
    const novo={id:uid(), empresa, endereco, telefone, email, segmento, insumos:[]};
    state.clientes.unshift(novo);
    state.selectedClienteId=novo.id;
    state.selectedInsumoId=null;
    saveState();
    clienteForm.reset();
    renderAll();
  });

  insumoForm.addEventListener("submit",(e)=>{
    e.preventDefault();
    const c=getSelectedCliente(); if(!c) return;
    const insumo=$("#insumo").value.trim();
    const tipo=$("#tipo").value.trim();
    const fornecedor=$("#fornecedor").value.trim();
    if(!insumo||!tipo||!fornecedor) return;
    c.insumos=Array.isArray(c.insumos)?c.insumos:[];
    const valor = numOr0($("#valorKg").value);
    const novo={id:uid(), insumo, tipo, fornecedor, valorKg: valor, caracteristicas:null};
    c.insumos.unshift(novo);
    state.selectedInsumoId=novo.id;
    saveState();
    insumoForm.reset();
    renderAll();
  });

  $("#limparInsumoBtn").addEventListener("click", ()=>insumoForm.reset());

  $("#abrirModalCarBtn").addEventListener("click", openCaracteristicasModal);
  carModalCloseBtn.addEventListener("click", closeCaracteristicasModal);
  carModalBackdrop.addEventListener("click",(e)=>{ if(e.target===carModalBackdrop) closeCaracteristicasModal(); });
  document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && carModalBackdrop.style.display==="flex") closeCaracteristicasModal(); });

  resetGranBtn.addEventListener("click", ()=>{
    const ok=confirm("Zerar todas as massas retidas (incluindo FUNDO)?"); if(!ok) return;
    modalGranMasses={}; for(const mm of SIEVES_MM) modalGranMasses[String(mm)]=""; modalGranMasses["fundo"]="";
    renderGranTableInitial();
  });

  salvarCaracteristicasBtn.addEventListener("click", ()=>{
    const c=getSelectedCliente(); const ins=getSelectedInsumo(); if(!(c&&ins)) return;
    const active=document.activeElement;
    if(active && active.classList?.contains("gran-massa")) commitValueFromInput(active);
    const massaEspecifica=numOr0(massaEspecificaInput.value);
    if(!(massaEspecifica>0)){ alert("Informe a massa específica (> 0)."); massaEspecificaInput.focus(); return; }
    const computed=computeGranulometry(modalGranMasses);
    if(!(computed.total>0)){ alert("Informe ao menos uma massa retida (> 0)."); return; }
    if(valorKgModal){
      ins.valorKg = numOr0(valorKgModal.value);
    }
    ins.caracteristicas={
      massaEspecifica: round(massaEspecifica,3),
      mf: round(computed.mf,2),
      granulometria:{
        masses:{ ...Object.fromEntries(SIEVES_MM.map(mm=>[String(mm), round(numOr0(modalGranMasses[String(mm)]),2)])), fundo: round(numOr0(modalGranMasses["fundo"]),2) },
        total: round(computed.total,2),
        rows: computed.rows.map(r=>({mm:r.mm, massa: round(r.massa,2), perc: round(r.perc,4), acum: round(r.acum,4), pass: round(r.pass,4)})),
        fundo:{ massa: round(computed.fundo.massa,2), perc: round(computed.fundo.perc,4), acum: round(computed.fundo.acum,4), pass: round(computed.fundo.pass,4) },
        mfSieves: MF_SIEVES.slice()
      }
    };
    saveState();
    renderAll();
    closeCaracteristicasModal();
    alert("Características salvas.");

    if(state.lastTraco && Array.isArray(state.lastTraco.materials)){
      const used = state.lastTraco.materials.some(m => m.insumo && m.insumo.id === ins.id);
      if(used){
        computeAndRenderMixGran();
      }
    }
  });

  /* =========  PRINT / DOSAGEM: umidade e correções automáticas ========= */
  function updateUmidadeCorrections(){
    const last = state.lastTraco;
    if(!last || !last.traco1m3) return;

    const volume = Math.max(0, numOr0(state.printForm.volumeLab) || numOr0(state.printForm.volumeM3) || last?.volume || 1);

    const initialWater = (Number(last.traco1m3?.agua ?? 0)) * volume;

    const aguaAdicionadaEl = document.querySelector('[data-print-key="aguaAdicionada"]');
    const aguaAdicionada = aguaAdicionadaEl ? numOr0(aguaAdicionadaEl.value) : 0;

    let totalMoistureMass = 0;

    const rows = Array.from(printDosagemTbody.querySelectorAll("tr"));
    rows.forEach(tr => {
      const umInput = tr.querySelector('input[data-field="umidade"]');
      const key = umInput?.getAttribute("data-row") || "";
      const origDos = Number(tr.dataset.origDosagem ?? 0);
      const uPct = numOr0(umInput?.value || 0);

      const moistureMass = (origDos * (uPct / 100));
      const correctedWet = origDos * (1 + (uPct / 100));

      const corrCell = tr.querySelector('[data-col="corrigido"]');
      if(corrCell){
        corrCell.textContent = fmtPt(correctedWet,1);
      }else{
        const tds = tr.querySelectorAll("td");
        if(tds.length) tds[tds.length-1].textContent = fmtPt(correctedWet,1);
      }

      if(key !== "agua"){
        totalMoistureMass += moistureMass;
      }
    });

    const finalWater = Math.max(0, initialWater - totalMoistureMass + aguaAdicionada);

    const printAguaInicialEl = document.getElementById("printAguaInicial");
    const printAguaFinalEl = document.getElementById("printAguaFinal");
    const aguaCorrecaoEl = document.querySelector('[data-print-key="aguaCorrecao"]');

    if(printAguaInicialEl) printAguaInicialEl.value = fmtPt(initialWater,1);
    if(printAguaFinalEl) printAguaFinalEl.value = fmtPt(finalWater,1);
    if(aguaCorrecaoEl) aguaCorrecaoEl.value = fmtPt(-totalMoistureMass,1);

    const aguaRow = printDosagemTbody.querySelector('input[data-row="agua"]')?.closest("tr");
    if(aguaRow){
      const corrCell = aguaRow.querySelector('[data-col="corrigido"]') || aguaRow.querySelectorAll("td")[4];
      if(corrCell) corrCell.textContent = fmtPt(finalWater / Math.max(1, volume) ,1);
    }
  }

  function bindUmidadeInputs(){
    const inputs = printDosagemTbody.querySelectorAll('input[data-field="umidade"]');
    inputs.forEach(inp=>{
      inp.removeEventListener("input", updateUmidadeCorrections);
      inp.addEventListener("input", updateUmidadeCorrections);
      inp.addEventListener("change", updateUmidadeCorrections);
    });

    const aguaAdicionadaEl = document.querySelector('[data-print-key="aguaAdicionada"]');
    if(aguaAdicionadaEl){
      aguaAdicionadaEl.removeEventListener("input", updateUmidadeCorrections);
      aguaAdicionadaEl.addEventListener("input", updateUmidadeCorrections);
      aguaAdicionadaEl.addEventListener("change", updateUmidadeCorrections);
    }

    updateUmidadeCorrections();
  }

  function renderPrintPanel(){
    if(!state.printForm) state.printForm={};
    if(!state.printForm.data) state.printForm.data=new Date().toISOString().slice(0,10);
    if(state.printForm.codigo===undefined) state.printForm.codigo="";
    if(state.printForm.tituloLivre===undefined) state.printForm.tituloLivre="";
    if(!state.printForm.numeroTraco) state.printForm.numeroTraco="001";
    if(!state.printForm.volumeM3) state.printForm.volumeM3=state.lastTraco?.volume ?? 1;
    if(state.printForm.volumeLab===undefined) state.printForm.volumeLab="";
    if(!state.printForm.resistencias){
      state.printForm.resistencias=RUPTURA_DIAS.map(d=>({ idade:`${d} dias`, comp:"", aashto:"", tracao:"", evol:"" }));
    }
    if(state.printForm.resistencias.length < RUPTURA_DIAS.length){
      const existing=state.printForm.resistencias;
      state.printForm.resistencias=RUPTURA_DIAS.map((d,idx)=> existing[idx] || { idade:`${d} dias`, comp:"", aashto:"", tracao:"", evol:"" });
    }

    document.querySelectorAll("[data-print-key]").forEach(el=>{
      const key=el.getAttribute("data-print-key");
      if(!key) return; 
      if(state.printForm[key]!==undefined) el.value=state.printForm[key];
      el.removeEventListener("input", ()=>{});
      el.addEventListener("input", ()=>{
        state.printForm[key]=el.value;
        saveState();
        renderPrintPanel();
      });
    });

    const last=state.lastTraco;
    const volume=Math.max(0, numOr0(state.printForm.volumeLab) || numOr0(state.printForm.volumeM3) || last?.volume || 1);

    const tbodyMat=printMateriaisInfo.querySelector("tbody");
    if(tbodyMat){
      tbodyMat.innerHTML="";
      if(last && last.materials){
        last.materials.forEach(mat=>{
          const tr=document.createElement("tr");
          const ins=mat.insumo;
          const desc=ins ? `${ins.insumo} • ${ins.fornecedor}` : "-";
          const teorVal = mat.key==="adicao" ? `${fmtPt(last.inputs.adicaoPct,2)}%` :
            mat.key==="aditivo1" ? `${fmtPt(last.inputs.aditivo1Pct,3)}%` :
            mat.key==="aditivo2" ? `${fmtPt(last.inputs.aditivo2Pct,3)}%` : "-";
          tr.innerHTML=`
            <td>${mat.label}</td>
            <td contenteditable="true" data-mat="${mat.key}" data-field="desc">${escapeHtml(desc)}</td>
            <td class="right nowrap" contenteditable="true" data-mat="${mat.key}" data-field="teor">${escapeHtml(teorVal)}</td>
          `;
          tbodyMat.appendChild(tr);
        });
      } else {
        const tr=document.createElement("tr");
        tr.innerHTML=`<td colspan="3">Calcule o traço para preencher as informações.</td>`;
        tbodyMat.appendChild(tr);
      }
    }

    printDosagemTbody.innerHTML="";
    if(last && last.materials){
      last.materials.forEach(mat=>{
        const key=mat.key;
        const dosagem=(last.traco1m3[key] ?? 0) * volume; // dosagem for the chosen volume
        const tr=document.createElement("tr");
        tr.dataset.origDosagem = String(dosagem);
        tr.innerHTML=`
          <td>${mat.label}</td>
          <td class="right nowrap">${fmtPt(dosagem,1)}</td>
          <td class="center">-</td>
          <td class="center"><input data-row="${key}" data-field="umidade" value="" /></td>
          <td class="right nowrap" data-col="corrigido">${fmtPt(dosagem,1)}</td>
        `;
        printDosagemTbody.appendChild(tr);
      });
    } else {
      const tr=document.createElement("tr");
      tr.innerHTML=`<td colspan="5">Calcule o traço para preencher a dosagem.</td>`;
      printDosagemTbody.appendChild(tr);
    }

    const baseDate=state.printForm.data || last?.dataEstudo;
    const ruptureDates=RUPTURA_DIAS.map(d=>addDays(baseDate, d));
    printResistenciaTbody.innerHTML="";
    state.printForm.resistencias.forEach((row,idx)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${row.idade || `${RUPTURA_DIAS[idx]} dias`}</td>
        <td class="center"><input value="${ruptureDates[idx] ?? ""}" disabled /></td>
        <td class="right"><input data-res-idx="${idx}" data-res-field="comp" value="${row.comp ?? ""}" /></td>
        <td class="right"><input data-res-idx="${idx}" data-res-field="aashto" value="${row.aashto ?? ""}" /></td>
        <td class="right"><input data-res-idx="${idx}" data-res-field="tracao" value="${row.tracao ?? ""}" /></td>
        <td class="right"><input data-res-idx="${idx}" data-res-field="evol" value="${row.evol ?? ""}" /></td>
      `;
      printResistenciaTbody.appendChild(tr);
    });

    const ar=last?.inputs?.ar ?? 0;
    $("#printArInc").value=fmtPt(ar,1);
    $("#printAC").value= last ? fmtPt(last.inputs.ac,3) : "";
    $("#printAagl").value= last ? fmtPt(last.inputs.ac,3) : "";
    $("#printK").value= last ? `${fmtPt(last.inputs.argamassa,2)}%` : "";
    $("#printH").value= last ? `${fmtPt(last.inputs.h,2)}%` : "";
    $("#printACReal").value= last ? fmtPt(last.inputs.ac,3) : "";
    $("#printHReal").value= last ? `${fmtPt(last.inputs.h,2)}%` : "";

    document.querySelector('[data-print-key="slump15"]').value = state.printForm.slump15 || "";
    document.querySelector('[data-print-key="slumpCorrigido"]').value = state.printForm.slumpCorrigido || "";

    bindUmidadeInputs();
  }

  printPdfBtn.addEventListener("click", ()=>{
    setActiveTab("traco");
    document.querySelector(".print-sheet")?.scrollIntoView({behavior:"smooth", block:"start"});
    setTimeout(()=>window.print(),150);
  });

  /* ========= HISTÓRICO RENDER (mantém funcionalidade) ========= */
  function renderHistorico(){
    if(typeof renderHistorico._impl === "function") renderHistorico._impl();
  }

  function pickInsumo(insumos, key){
    return (insumos||[]).find(x=>x.key===key) || null;
  }
  function fmtInsumo(ins){
    if(!ins) return "-";
    if(ins.display) return ins.display;
    return `${ins.insumo||"-"} (${ins.tipo||"-"}/${ins.fornecedor||"-"})`;
  }
  function pickQuant(qs, key){
    const f = (qs||[]).find(x=>x.key===key);
    if(!f) return "-";
    if(f.display) return f.display;
    return `${fmtPt(f.dosagem,1)} kg / ${formatPercentDisplay(f.umidade)} / ${fmtPt(f.corrigido,1)} kg`;
  }
  function pickRes(resArr, idx){
    const r = (resArr||[])[idx];
    if(!r) return "-";
    if(r.display) return r.display;
    return `${r.data||"-"} / C=${r.comp||"-"} / T=${r.tracao||"-"} / Ev=${r.evol||"-"}`;
  }

  function toggleRowEditing(tr, editing){
    const tds = Array.from(tr.querySelectorAll("td"));
    tds.pop();
    tds.forEach(td=>{
      td.contentEditable = editing ? "true" : "false";
      td.classList.toggle("editing-cell", editing);
    });
  }

  function saveInsumosRowAtIndex(idx, values){
    const traco = state.tracosHistorico[idx];
    if(!traco) return;
    traco.numeroTraco = values[0] || traco.numeroTraco;
    traco.clienteNome = values[1] || traco.clienteNome;
    const keys=["cimento","adicao","areia1","areia2","areia3","brita0","brita12","brita1","agua","aditivo1","aditivo2"];
    keys.forEach((key,i)=>{
      const txt = values[i+2] || "";
      let entry = (traco.insumos||[]).find(x=>x.key===key);
      if(!entry){ entry = { material:key, key, insumo:txt, tipo:"", fornecedor:"" }; (traco.insumos||[]).push(entry); }
      entry.insumo = txt;
      entry.display = txt;
    });
    saveState();
    renderHistorico();
  }

  function saveQuantRowAtIndex(idx, values){
    const traco = state.tracosHistorico[idx];
    if(!traco) return;
    traco.numeroTraco = values[0] || traco.numeroTraco;
    traco.clienteNome = values[1] || traco.clienteNome;
    const keys=["cimento","adicao","areia1","areia2","areia3","brita0","brita12","brita1","agua","aditivo1","aditivo2"];
    keys.forEach((key,i)=>{
      const txt = values[i+2] || "";
      let entry = (traco.quantidades||[]).find(x=>x.key===key);
      if(!entry){ entry = { key, dosagem:0, umidade:0, corrigido:0 }; (traco.quantidades||[]).push(entry); }
      entry.display = txt;
    });
    saveState();
    renderHistorico();
  }

  function saveResRowAtIndex(idx, values){
    const traco = state.tracosHistorico[idx];
    if(!traco) return;
    traco.numeroTraco = values[0] || traco.numeroTraco;
    traco.clienteNome = values[1] || traco.clienteNome;
    traco.dataEstudo = values[2] || traco.dataEstudo || "";
    const resArr = traco.resultados || [];
    for(let i=0;i<RUPTURA_DIAS.length;i++){
      const txt = values[i+3] || "";
      if(!resArr[i]) resArr[i] = { idade:`${RUPTURA_DIAS[i]} dias`, data:"", comp:"", tracao:"", evol:"" };
      resArr[i].display = txt;
    }
    traco.resultados = resArr;
    saveState();
    renderHistorico();
  }

  function saveFormRowAtIndex(idx, values){
    const traco = state.tracosHistorico[idx];
    if(!traco) return;
    traco.numeroTraco = values[0] || traco.numeroTraco;
    traco.clienteNome = values[1] || traco.clienteNome;
    const map=["data","slump","slump15","slumpCorrigido","aguaAdicionada","aguaRetida","tempConc","tempAmb","umidAmb","volumeM3","volumeLab"];
    const form = traco.form || {};
    map.forEach((key,i)=>{ form[key] = values[i+2] || form[key] || ""; });
    traco.form = form;
    traco.formEdits = { ...traco.formEdits, ...form };
    saveState();
  }

  // implement renderHistorico._impl (keeps original behaviour from provided file)
  renderHistorico._impl = function(){
    const hist=state.tracosHistorico||[];
    const histInsumosTbody=$("#histInsumosTbody");
    const histQuantTbody=$("#histQuantTbody");
    const histResultadosTbody=$("#histResultadosTbody");
    const histFormTbody=$("#histFormTbody");
    if(!hist.length){
      histInsumosTbody.innerHTML=`<tr><td colspan="14">Nenhum traço salvo.</td></tr>`;
      histQuantTbody.innerHTML=`<tr><td colspan="14">Nenhum traço salvo.</td></tr>`;
      histResultadosTbody.innerHTML=`<tr><td colspan="11">Nenhum traço salvo.</td></tr>`;
      histFormTbody.innerHTML=`<tr><td colspan="14">Nenhum traço salvo.</td></tr>`;
      return;
    }

    histInsumosTbody.innerHTML="";
    hist.forEach((traco, idx)=>{
      const ins = traco.insumos||[];
      const row=document.createElement("tr");
      row.dataset.histIndex = idx;
      const actionsHtml = `
        <div class="icon-actions">
          <button type="button" class="icon-btn icon-edit" data-action="edit" title="Editar" aria-label="Editar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
            </svg>
          </button>
          <button type="button" class="icon-btn icon-delete" data-action="delete" title="Excluir" aria-label="Excluir">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
              <path d="M10 11v6"></path>
              <path d="M14 11v6"></path>
            </svg>
          </button>
        </div>
      `;
      row.innerHTML=`
        <td>${escapeHtml(traco.numeroTraco)}</td>
        <td>${escapeHtml(traco.clienteNome||"-")}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"cimento")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"adicao")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"areia1")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"areia2")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"areia3")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"brita0")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"brita12")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"brita1")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"agua")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"aditivo1")))}</td>
        <td>${escapeHtml(fmtInsumo(pickInsumo(ins,"aditivo2")))}</td>
        <td class="nowrap">${actionsHtml}</td>
      `;
      const editBtn = row.querySelector('[data-action="edit"]');
      editBtn.addEventListener("click", ()=>{
        const editing = editBtn.dataset.mode !== "save";
        if(editing){
          editBtn.dataset.mode="save";
          editBtn.title = "Salvar";
          toggleRowEditing(row,true);
        }else{
          const values = Array.from(row.querySelectorAll("td")).slice(0,-1).map(td=>td.textContent.trim());
          toggleRowEditing(row,false);
          editBtn.dataset.mode="edit";
          editBtn.title = "Editar";
          saveInsumosRowAtIndex(idx, values);
        }
      });
      row.querySelector('[data-action="delete"]').addEventListener("click", ()=>{
        if(!confirm("Excluir este registro do histórico?")) return;
        state.tracosHistorico = state.tracosHistorico.filter((_,i)=>i!==idx);
        saveState(); renderHistorico();
        renderCorrigidoInit();
      });
      histInsumosTbody.appendChild(row);
    });

    // Quantities
    histQuantTbody.innerHTML="";
    hist.forEach((traco, idx)=>{
      const qs=traco.quantidades||[];
      const row=document.createElement("tr");
      row.innerHTML=`
        <td>${escapeHtml(traco.numeroTraco)}</td>
        <td>${escapeHtml(traco.clienteNome||"-")}</td>
        <td>${escapeHtml(pickQuant(qs,"cimento"))}</td>
        <td>${escapeHtml(pickQuant(qs,"adicao"))}</td>
        <td>${escapeHtml(pickQuant(qs,"areia1"))}</td>
        <td>${escapeHtml(pickQuant(qs,"areia2"))}</td>
        <td>${escapeHtml(pickQuant(qs,"areia3"))}</td>
        <td>${escapeHtml(pickQuant(qs,"brita0"))}</td>
        <td>${escapeHtml(pickQuant(qs,"brita12"))}</td>
        <td>${escapeHtml(pickQuant(qs,"brita1"))}</td>
        <td>${escapeHtml(pickQuant(qs,"agua"))}</td>
        <td>${escapeHtml(pickQuant(qs,"aditivo1"))}</td>
        <td>${escapeHtml(pickQuant(qs,"aditivo2"))}</td>
        <td class="nowrap">
          <div class="icon-actions">
            <button type="button" class="icon-btn icon-edit" data-action="edit" title="Editar" aria-label="Editar">E</button>
            <button type="button" class="icon-btn icon-delete" data-action="delete" title="Excluir" aria-label="Excluir">X</button>
          </div>
        </td>
      `;
      const editBtn = row.querySelector('[data-action="edit"]');
      editBtn.addEventListener("click", ()=>{
        const editing = editBtn.dataset.mode !== "save";
        if(editing){
          editBtn.dataset.mode="save";
          editBtn.title = "Salvar";
          toggleRowEditing(row,true);
        }else{
          const values = Array.from(row.querySelectorAll("td")).slice(0,-1).map(td=>td.textContent.trim());
          toggleRowEditing(row,false);
          editBtn.dataset.mode="edit";
          editBtn.title = "Editar";
          saveQuantRowAtIndex(idx, values);
        }
      });
      row.querySelector('[data-action="delete"]').addEventListener("click", ()=>{
        if(!confirm("Excluir este registro do histórico?")) return;
        state.tracosHistorico = state.tracosHistorico.filter((_,i)=>i!==idx);
        saveState(); renderHistorico();
        renderCorrigidoInit();
      });
      histQuantTbody.appendChild(row);
    });

    // Resultados
    histResultadosTbody.innerHTML="";
    hist.forEach((traco, idx)=>{
      const res = traco.resultados||[];
      const row=document.createElement("tr");
      row.innerHTML=`
        <td>${escapeHtml(traco.numeroTraco)}</td>
        <td>${escapeHtml(traco.clienteNome||"-")}</td>
        <td>${escapeHtml(traco.dataEstudo||"-")}</td>
        <td>${escapeHtml(pickRes(res,0))}</td>
        <td>${escapeHtml(pickRes(res,1))}</td>
        <td>${escapeHtml(pickRes(res,2))}</td>
        <td>${escapeHtml(pickRes(res,3))}</td>
        <td>${escapeHtml(pickRes(res,4))}</td>
        <td>${escapeHtml(pickRes(res,5))}</td>
        <td>${escapeHtml(pickRes(res,6))}</td>
        <td class="nowrap">
          <div class="icon-actions">
            <button type="button" class="icon-btn icon-edit" data-action="edit" title="Editar" aria-label="Editar">E</button>
            <button type="button" class="icon-btn icon-delete" data-action="delete" title="Excluir" aria-label="Excluir">X</button>
          </div>
        </td>
      `;
      const editBtn = row.querySelector('[data-action="edit"]');
      editBtn.addEventListener("click", ()=>{
        const editing = editBtn.dataset.mode !== "save";
        if(editing){
          editBtn.dataset.mode="save";
          editBtn.title = "Salvar";
          toggleRowEditing(row,true);
        }else{
          const values = Array.from(row.querySelectorAll("td")).slice(0,-1).map(td=>td.textContent.trim());
          toggleRowEditing(row,false);
          editBtn.dataset.mode="edit";
          editBtn.title = "Editar";
          saveResRowAtIndex(idx, values);
        }
      });
      row.querySelector('[data-action="delete"]').addEventListener("click", ()=>{
        if(!confirm("Excluir este registro do histórico?")) return;
        state.tracosHistorico = state.tracosHistorico.filter((_,i)=>i!==idx);
        saveState(); renderHistorico();
        renderCorrigidoInit();
      });
      histResultadosTbody.appendChild(row);
    });

    // Form snapshots
    histFormTbody.innerHTML="";
    hist.forEach((traco, idx)=>{
      const f = traco.form || {};
      const row=document.createElement("tr");
      row.innerHTML=`
        <td>${escapeHtml(traco.numeroTraco)}</td>
        <td>${escapeHtml(traco.clienteNome||"-")}</td>
        <td>${escapeHtml(f.data||"")}</td>
        <td>${escapeHtml(f.slump||"")}</td>
        <td>${escapeHtml(f.slump15||"")}</td>
        <td>${escapeHtml(f.slumpCorrigido||"")}</td>
        <td>${escapeHtml(f.aguaAdicionada||"")}</td>
        <td>${escapeHtml(f.aguaRetida||"")}</td>
        <td>${escapeHtml(f.tempConc||"")}</td>
        <td>${escapeHtml(f.tempAmb||"")}</td>
        <td>${escapeHtml(f.umidAmb||"")}</td>
        <td>${escapeHtml(f.volumeM3 ?? "")}</td>
        <td>${escapeHtml(f.volumeLab ?? "")}</td>
        <td class="nowrap">
          <div class="icon-actions">
            <button type="button" class="icon-btn icon-edit" data-action="edit" title="Editar" aria-label="Editar">E</button>
            <button type="button" class="icon-btn icon-delete" data-action="delete" title="Excluir" aria-label="Excluir">X</button>
          </div>
        </td>
      `;
      const editBtn = row.querySelector('[data-action="edit"]');
      editBtn.addEventListener("click", ()=>{
        const editing = editBtn.dataset.mode !== "save";
        if(editing){
          editBtn.dataset.mode="save";
          editBtn.title = "Salvar";
          toggleRowEditing(row,true);
        }else{
          const values = Array.from(row.querySelectorAll("td")).slice(0,-1).map(td=>td.textContent.trim());
          toggleRowEditing(row,false);
          editBtn.dataset.mode="edit";
          editBtn.title = "Editar";
          saveFormRowAtIndex(idx, values);
        }
      });
      row.querySelector('[data-action="delete"]').addEventListener("click", ()=>{
        if(!confirm("Excluir este registro do histórico?")) return;
        state.tracosHistorico = state.tracosHistorico.filter((_,i)=>i!==idx);
        saveState(); renderHistorico();
        renderCorrigidoInit();
      });
      histFormTbody.appendChild(row);
    });
  };

  /* =========================================================================
     CORRIGIDO Tab - functions to compute, render and manage corrected traces.
     Fixed issues:
      - Avoid repeated listener registration.
      - Avoid accidental recursion and stack overflow.
      - Implement computeCorrigidoFromHist + rendering + saving.
     ========================================================================= */

  function findInsumoValorAndMEByDisplay(displayText){
    // lookup insumo by display (insumo name) across all clients to get cost and ME if available
    if(!displayText) return { valorKg: 0, me: null };
    for(const c of (state.clientes||[])){
      for(const ins of (c.insumos||[])){
        if(((ins.insumo || "") + (ins.fornecedor ? ` (${ins.fornecedor})` : "")).trim() === displayText.trim() ||
           (ins.insumo || "").trim() === displayText.trim()){
          return { valorKg: numOr0(ins.valorKg), me: ins.caracteristicas?.massaEspecifica ?? null };
        }
      }
    }
    return { valorKg: 0, me: null };
  }

  function computeCorrigidoFromHist(traco, density){
    // density in g/cm3 -> kg/m3 = density*1000
    const targetMassPerM3 = numOr0(density) * 1000;
    // get original dosages per m3
    const orig = {};
    if(Array.isArray(traco.quantidades) && traco.quantidades.length){
      traco.quantidades.forEach(q => { orig[q.key] = numOr0(q.dosagem); });
    }
    // fallback to traco.traco1m3 if present
    if(!Object.keys(orig).length && traco.traco1m3){
      for(const k of Object.keys(traco.traco1m3)) orig[k] = numOr0(traco.traco1m3[k]);
    }
    // If still empty, attempt to derive from traco.insumos+traco.form (unlikely)
    const originalTotal = Object.values(orig).reduce((s,v)=>s+v, 0) || 0;

    // Water correction: use form values if present
    const form = traco.form || {};
    // initialWater per m3: use orig['agua'] if present else form.aguaInicial if provided
    let initialWater = orig['agua'] ?? numOr0(form.aguaInicial) ?? 0;
    // If form contains aguaAdicionada/aguaRetida use them (they may be absolute L or kg - assume kg)
    const aguaAdicionada = numOr0(form.aguaAdicionada);
    const aguaRetida = numOr0(form.aguaRetida);
    const finalWater = Math.max(0, initialWater + aguaAdicionada - aguaRetida);

    // If originalTotal is zero, we'll just scale proportionally using solids only (avoid divide by zero)
    let factor = 1;
    if(originalTotal > 0){
      factor = (targetMassPerM3 > 0) ? (targetMassPerM3 / originalTotal) : 1;
    } else {
      // if no original total, but traco.traco1m3 may have concrete total mass; else factor=1
      factor = 1;
    }

    // build corrected dosages
    const corrected = {};
    const details = {};
    let totalCost = 0;
    const keys = new Set([...Object.keys(orig), "cimento","adicao","areia1","areia2","areia3","brita0","brita12","brita1","agua","aditivo1","aditivo2"]);
    keys.forEach(k=>{
      const o = numOr0(orig[k]);
      // compute corrected value
      let cVal = o * factor;
      // we'll override water with finalWater value (per m3)
      if(k === "agua") cVal = finalWater;
      corrected[k] = cVal;
      // find cost and me if possible from traco.insumos display values (insumos array may have display)
      let valor = 0;
      let me = null;
      // try matching traco.insumos entry
      const insEntry = (traco.insumos || []).find(x => x.key === k);
      if(insEntry){
        // insEntry.display may be like "Name (Fornecedor)"
        const found = findInsumoValorAndMEByDisplay(insEntry.display || insEntry.insumo);
        valor = found.valorKg || 0;
        me = found.me ?? me;
      } else {
        const found = findInsumoValorAndMEByDisplay((insEntry && insEntry.display) || "");
        valor = found.valorKg || 0;
        me = found.me ?? me;
      }
      const cost = cVal * (valor || 0);
      totalCost += cost;
      details[k] = { original: o, corrected: cVal, valorKg: valor, me };
    });

    return {
      originalTotal,
      targetMassPerM3,
      factor,
      initialWater,
      finalWater,
      correctedDos: corrected,
      details,
      totalCost: round(totalCost,2)
    };
  }

  function renderCorrigidoResult(res, traco){
    const tbody = document.getElementById("corrDosagemTbody");
    const costTotalEl = document.getElementById("corrCostTotal");
    const corrCEl = document.getElementById("corrC");
    const corrR = document.getElementById("corrR");
    const corrVt = document.getElementById("corrVt");
    const corrIa = document.getElementById("corrIa");
    const corrA = document.getElementById("corrA");
    const corrAC = document.getElementById("corrAC");
    tbody.innerHTML = "";
    if(!res || !res.correctedDos) {
      if(costTotalEl) costTotalEl.value = "";
      if(corrCEl) corrCEl.value = "";
      if(corrR) corrR.value = "";
      if(corrVt) corrVt.value = "";
      if(corrIa) corrIa.value = "";
      if(corrA) corrA.value = "";
      if(corrAC) corrAC.value = "";
      return;
    }

    const order = ["cimento","adicao","areia1","areia2","areia3","brita0","brita12","brita1","agua","aditivo1","aditivo2"];
    order.forEach(key=>{
      const det = res.details[key] || { original:0, corrected:0, valorKg:0, me: null };
      const labelMap = {
        cimento:"Cimento", adicao:"Adição", areia1:"Areia 1", areia2:"Areia 2", areia3:"Areia 3",
        brita0:"Brita 0", brita12:"Brita 1/2", brita1:"Brita 1", agua:"Água", aditivo1:"Aditivo 1", aditivo2:"Aditivo 2"
      };
      const tr = document.createElement("tr");
      const costRow = round(det.corrected * (det.valorKg||0),2);
      tr.innerHTML = `
        <td>${labelMap[key] || key}</td>
        <td class="right">${fmtPt(det.original,1)}</td>
        <td class="right">${fmtPt(det.corrected,1)}</td>
        <td class="right">${det.me ? Number(det.me).toLocaleString("pt-BR",{minimumFractionDigits:3, maximumFractionDigits:3}) : "—"}</td>
        <td class="right">${det.valorKg ? fmtPt(det.valorKg,2) : "—"}</td>
        <td class="right">${det.valorKg ? fmtPt(costRow,2) : "—"}</td>
      `;
      tbody.appendChild(tr);
    });

    if(costTotalEl) costTotalEl.value = fmtPt(res.totalCost,2);
    if(corrCEl) corrCEl.value = fmtPt(res.correctedDos["cimento"] || 0,1);
    if(corrR) corrR.value = fmtPt(res.factor,4);
    if(corrVt) corrVt.value = fmtPt(1,3);
    if(corrIa) corrIa.value = fmtPt(numOr0(traco.form?.ar) || 0,2);
    if(corrA) corrA.value = formatPercentDisplay(numOr0(traco.form?.ar) || 0);
    if(corrAC) corrAC.value = fmtPt(numOr0(traco.inputs?.ac) || 0,3);
  }

  function renderCorrigidoSavedList(){
    const tbody = document.getElementById("corrSavedTbody");
    tbody.innerHTML = "";
    const items = state.tracosCorrigidos || [];
    if(!items.length){
      tbody.innerHTML = `<tr><td colspan="6">Nenhum traço corrigido salvo.</td></tr>`;
      return;
    }
    items.forEach((it, idx)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(it.id)}</td>
        <td>${escapeHtml(it.origemNum || "")}</td>
        <td>${escapeHtml(it.cliente || "")}</td>
        <td>${escapeHtml(it.data || "")}</td>
        <td class="right">${fmtPt(it.res ? (it.res.correctedDos?.cimento || 0) : 0,2)}</td>
        <td class="nowrap">
          <div class="icon-actions">
            <button class="icon-btn" data-action="view" title="Ver">V</button>
            <button class="icon-btn icon-delete" data-action="delete" title="Excluir">X</button>
          </div>
        </td>
      `;
      tr.querySelector('[data-action="view"]')?.addEventListener("click", ()=>{
        renderCorrigidoResult(it.result, { form: {}, inputs: {} });
        alert("Traço corrigido carregado no painel (visualização).");
      });
      tr.querySelector('[data-action="delete"]')?.addEventListener("click", ()=>{
        if(!confirm("Excluir este traço corrigido salvo?")) return;
        state.tracosCorrigidos = state.tracosCorrigidos.filter(x=>x.id!==it.id);
        saveState();
        renderCorrigidoSavedList();
      });
      tbody.appendChild(tr);
    });
  }

  function renderCorrigidoInit(){
    // populate select with history items
    const sel = document.getElementById("corrSelectTraco");
    if(!sel) return;
    const filterEl = document.getElementById("corrHistFilter");
    const list = state.tracosHistorico || [];
    const prev = sel.value;
    sel.innerHTML = "";
    list.forEach(h=>{
      const opt = document.createElement("option");
      opt.value = h.numeroTraco || h.id || (h.createdAt || "");
      opt.textContent = `${h.numeroTraco || h.id} — ${h.clienteNome || ""} — ${h.dataEstudo || ""}`;
      // store index to retrieve quickly
      opt.dataset.histIndex = String(list.indexOf(h));
      sel.appendChild(opt);
    });
    if(prev && Array.from(sel.options).some(o=>o.value===prev)) sel.value = prev;
    // filter handler
    if(filterEl){
      filterEl.removeEventListener("input", onCorrFilter);
      filterEl.addEventListener("input", onCorrFilter);
    }
    renderCorrigidoSavedList();
    // build resistance inputs once
    const resWrap = document.getElementById("corrResInputs");
    if(resWrap){
      resWrap.innerHTML = "";
      for(let i=0;i<RUPTURA_DIAS.length;i++){
        const inp = document.createElement("div");
        inp.innerHTML = `<label>${RUPTURA_DIAS[i]} dias</label><input data-ruptura-idx="${i}" class="corr-res-input" />`;
        resWrap.appendChild(inp);
      }
    }
    // ensure handlers installed
    initCorrigidoHandlers();
    if(sel && sel.options.length) {
      document.getElementById("corrStatus").textContent = "Pronto para cálculo.";
    } else {
      document.getElementById("corrStatus").textContent = "Histórico vazio.";
    }
  }

  function onCorrFilter(e){
    const term = String(e.target.value || "").toLowerCase().trim();
    const sel = document.getElementById("corrSelectTraco");
    if(!sel) return;
    for(const opt of sel.options){
      const txt = (opt.textContent||"").toLowerCase();
      if(!term || txt.includes(term)) opt.hidden = false;
      else opt.hidden = true;
    }
  }

  // Safe registration of corrigido handlers (from patch)
  (function initCorrigidoHandlers(){
    const sel = document.getElementById("corrSelectTraco");
    const calcBtn = document.getElementById("calcCorrigidoBtn");
    const saveBtn = document.getElementById("saveCorrigidoBtn");
    const clearBtn = document.getElementById("clearCorrigidoBtn");
    const statusEl = document.getElementById("corrStatus");

    function calcHandler(e){
      try{
        console.log("[corrigido] calcHandler disparado");
        const selId = sel ? sel.value : "";
        if(!selId){ alert("Selecione um traço do histórico."); return; }
        const traco = (state.tracosHistorico || []).find(t=> (t.numeroTraco === selId) || (t.id === selId) || (t.numeroTraco === selId));
        if(!traco){ alert("Traço não encontrado."); return; }
        const density = numOr0(document.getElementById("corrDensity").value) || 2.45;
        const res = computeCorrigidoFromHist(traco, density);
        renderCorrigidoResult(res, traco);
        if(sel){
          sel.dataset.lastResult = JSON.stringify(res);
          sel.dataset.lastTracoId = traco.id || "";
        }
        if(statusEl) statusEl.textContent = "Resultado gerado.";
      }catch(err){
        console.error("Erro em calcHandler:", err);
        alert("Erro ao calcular traço corrigido: " + (err && err.message ? err.message : err));
      }
    }

    function saveHandler(e){
      try{
        console.log("[corrigido] saveHandler disparado");
        const lastResRaw = sel ? sel.dataset.lastResult : null;
        const lastTracoId = sel ? sel.dataset.lastTracoId : null;
        if(!lastResRaw){ alert("Calcule o traço corrigido antes de salvar."); return; }
        const res = JSON.parse(lastResRaw);
        const orig = (state.tracosHistorico || []).find(t=>t.id === lastTracoId) || null;
        const resistInputs = Array.from(document.querySelectorAll(".corr-res-input")).map(inp=>inp.value.trim());
        const resistencias = resistInputs.map((v,i)=>({ idade: `${RUPTURA_DIAS[i]} dias`, display: v || "" }));
        const saveObj = {
          id: uid(),
          origemId: lastTracoId,
          origemNum: orig?.numeroTraco || "",
          cliente: orig?.clienteNome || "",
          data: orig?.dataEstudo || orig?.createdAt || new Date().toISOString().slice(0,10),
          density: numOr0(document.getElementById("corrDensity").value),
          note: document.getElementById("corrNote").value || "",
          summary: document.getElementById("corrResTitle").value || "",
          result: res,
          resistencias
        };
        if(document.getElementById("corrSaveAs").value === "tracosCorrigidos"){
          state.tracosCorrigidos = state.tracosCorrigidos || [];
          state.tracosCorrigidos.unshift(saveObj);
        } else {
          state.tracosSalvos = state.tracosSalvos || [];
          const snapshot = {
            id: saveObj.id,
            clienteNome: saveObj.cliente,
            titulo: saveObj.summary || `Corrigido ${saveObj.origemNum}`,
            dataEstudo: saveObj.data,
            volume: 1,
            inputs: {},
            materials: [],
            traco1m3: res.correctedDos,
            tracoVol: Object.fromEntries(Object.entries(res.correctedDos).map(([k,v])=>[k, v * 1])),
            resumoInsumos: `Corrigido de ${saveObj.origemNum}`
          };
          state.tracosSalvos.unshift(snapshot);
        }
        saveState();
        renderCorrigidoSavedList();
        renderTracosSalvos();
        alert("Traço corrigido salvo.");
        if(statusEl) statusEl.textContent = "Salvo.";
      }catch(err){
        console.error("Erro em saveHandler:", err);
        alert("Erro ao salvar traço corrigido: " + (err && err.message ? err.message : err));
      }
    }

    function clearHandler(e){
      try{
        console.log("[corrigido] clearHandler disparado");
        if(sel){
          sel.selectedIndex = -1;
          sel.dataset.lastResult = "";
          sel.dataset.lastTracoId = "";
        }
        const filter = document.getElementById("corrHistFilter");
        if(filter) filter.value = "";
        renderCorrigidoResult(null, null);
        if(statusEl) statusEl.textContent = "Limpo";
      }catch(err){
        console.error("Erro em clearHandler:", err);
      }
    }

    // Remove old listeners safely and add the new ones (idempotent)
    if(calcBtn){
      try{ calcBtn.removeEventListener("click", calcHandler); }catch(e){}
      calcBtn.addEventListener("click", calcHandler);
    }
    if(saveBtn){
      try{ saveBtn.removeEventListener("click", saveHandler); }catch(e){}
      saveBtn.addEventListener("click", saveHandler);
    }
    if(clearBtn){
      try{ clearBtn.removeEventListener("click", clearHandler); }catch(e){}
      clearBtn.addEventListener("click", clearHandler);
    }

    if(sel){
      sel.removeEventListener("change", ()=>{ if(statusEl) statusEl.textContent = "Pronto para cálculo."; });
      sel.addEventListener("change", ()=>{ if(statusEl) statusEl.textContent = "Pronto para cálculo."; });
    }

    console.log("initCorrigidoHandlers: inicializado");
  })();

  /* ======= Helpers to render tracos salvos and full UI ======= */
  function renderTracosSalvos(){
    const tbody = tracosSalvosTbody;
    tbody.innerHTML = "";
    const list = state.tracosSalvos || [];
    if(!list.length){
      tracosSalvosEmpty.style.display = "";
      return;
    }
    tracosSalvosEmpty.style.display = "none";
    list.forEach(t=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${t.id}</td><td>${escapeHtml(t.clienteNome||"")}</td><td>${escapeHtml(t.titulo||"")}</td><td>${escapeHtml(t.dataEstudo||"")}</td><td>${escapeHtml(t.resumoInsumos||"")}</td><td class="nowrap">
        <div class="icon-actions"><button class="icon-btn" data-action="load">L</button><button class="icon-btn icon-delete" data-action="delete">X</button></div></td>`;
      tr.querySelector('[data-action="load"]').addEventListener("click", ()=>{
        state.lastTraco = t;
        saveState();
        renderPrintPanel();
        computeAndRenderMixGran();
        alert("Traço carregado.");
      });
      tr.querySelector('[data-action="delete"]').addEventListener("click", ()=>{
        if(!confirm("Excluir este traço salvo?")) return;
        state.tracosSalvos = state.tracosSalvos.filter(x=>x.id !== t.id);
        saveState();
        renderTracosSalvos();
      });
      tbody.appendChild(tr);
    });
  }

  /* ========= render / main ========= */
  function renderAll(){
    renderTopSelection();
    renderClientes();
    renderInsumos();
    renderCaracteristicasPanel();
    syncTracoUI(false);
    renderTracosSalvos();
    renderHistorico();
    renderCorrigidoInit();
  }

  // initial render
  setTimeout(()=>{
    renderAll();
    setActiveTab(state.activeTab || "clientes");
  }, 20);
</script>
</body>
</html>
